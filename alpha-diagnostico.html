<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha ‚Äî Diagn√≥stico</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #0a0a0a;
            color: #fafafa;
            min-height: 100vh;
            padding: 24px;
            line-height: 1.6;
        }
        .container { max-width: 640px; margin: 0 auto; }
        .lang-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        .lang-btn {
            background: transparent;
            border: 1px solid #404040;
            color: #737373;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-btn:hover, .lang-btn.active {
            border-color: #fafafa;
            color: #fafafa;
        }
        header { text-align: center; padding: 32px 0 48px; }
        .brand { font-size: 14px; font-weight: 600; color: #737373; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 8px; }
        .logo { font-size: 36px; font-weight: 300; letter-spacing: -0.02em; }
        .subtitle { font-size: 14px; color: #525252; margin-top: 4px; }

        /* Test mode banner */
        .test-banner {
            background: linear-gradient(90deg, #713f12, #854d0e);
            color: #fde047;
            text-align: center;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }
        .test-banner + .container { padding-top: 48px; }

        /* Footer */
        footer {
            text-align: center;
            padding: 48px 0 24px;
            color: #525252;
            font-size: 12px;
        }
        footer a { color: #737373; text-decoration: none; }
        footer a:hover { color: #fafafa; }

        .input-section { margin-bottom: 24px; }
        .input-section > label {
            display: block;
            font-size: 14px;
            color: #a3a3a3;
            margin-bottom: 12px;
        }

        /* Input Mode Toggle */
        .input-mode-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .mode-btn {
            flex: 1;
            background: #171717;
            border: 1px solid #262626;
            color: #a3a3a3;
            padding: 16px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .mode-btn:hover { border-color: #404040; }
        .mode-btn.active {
            border-color: #fafafa;
            color: #fafafa;
            background: #1a1a1a;
        }
        .mode-btn .icon { font-size: 20px; margin-bottom: 8px; display: block; }
        .mode-btn .label { font-weight: 500; display: block; }
        .mode-btn .hint { font-size: 11px; color: #525252; margin-top: 4px; display: block; }
        .mode-btn.active .hint { color: #737373; }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #262626;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
            display: none;
        }
        .upload-area.active { display: block; }
        .upload-area:hover { border-color: #404040; }
        .upload-area.dragover { border-color: #fafafa; background: #1a1a1a; }
        .upload-input { display: none; }
        .upload-icon { font-size: 32px; margin-bottom: 12px; }
        .upload-text { color: #a3a3a3; font-size: 14px; }
        .upload-hint { color: #525252; font-size: 12px; margin-top: 8px; }
        .upload-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }
        .upload-preview .img-wrapper {
            position: relative;
            width: 60px;
            height: 60px;
        }
        .upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #262626;
        }
        .upload-preview .remove-img {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .microcopy {
            font-size: 12px;
            color: #525252;
            margin-top: 8px;
        }

        /* Context Fields */
        .context-section {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .context-section h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #737373;
            margin-bottom: 16px;
        }
        .context-field { margin-bottom: 16px; }
        .context-field:last-child { margin-bottom: 0; }
        .context-field label {
            display: block;
            font-size: 13px;
            color: #a3a3a3;
            margin-bottom: 8px;
        }
        .context-field input[type="text"] {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 12px;
            color: #fafafa;
            font-family: inherit;
            font-size: 14px;
        }
        .context-field input[type="text"]:focus { outline: none; border-color: #525252; }
        .context-field input[type="text"]::placeholder { color: #525252; }
        .context-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .context-option {
            background: #0a0a0a;
            border: 1px solid #262626;
            color: #a3a3a3;
            padding: 8px 14px;
            font-size: 13px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .context-option:hover { border-color: #404040; }
        .context-option.selected {
            border-color: #fafafa;
            color: #fafafa;
            background: #1a1a1a;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 16px;
            color: #fafafa;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: #525252; }
        textarea::placeholder { color: #525252; }
        .text-input-wrapper { display: block; }
        .text-input-wrapper.hidden { display: none; }
        .hidden { display: none !important; }
        .doubt-input { margin-top: 12px; }
        .dating-subtype { margin-top: -8px; }

        .analyze-btn {
            width: 100%;
            background: #fafafa;
            color: #0a0a0a;
            border: none;
            padding: 16px 32px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }
        .analyze-btn:hover { background: #e5e5e5; }
        .analyze-btn:disabled { background: #404040; color: #737373; cursor: not-allowed; }

        .error-msg {
            background: #1c1917;
            border: 1px solid #7c2d12;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #fbbf24;
            display: none;
        }
        .error-msg.active { display: block; }

        .results { display: none; }
        .results.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Output Structure */
        .result-block {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .result-block h3 {
            font-size: 13px;
            font-weight: 500;
            color: #fafafa;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-block h3 .emoji { font-size: 16px; }
        .result-block p { font-size: 15px; color: #e5e5e5; line-height: 1.6; }

        .diagnostico-central {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #1e3a5f;
        }
        .diagnostico-central p {
            font-size: 18px;
            font-weight: 500;
            color: #fafafa;
        }

        .risco-real {
            border-color: #7c2d12;
            background: #1c1917;
        }
        .risco-real p { color: #fbbf24; }

        .proximo-movimento {
            border-color: #22c55e33;
            background: #0a1f0a;
        }
        .proximo-movimento p { color: #86efac; }

        /* Abuse/Risk Screening Block */
        .triagem-risco {
            border-color: #dc2626;
            background: linear-gradient(135deg, #1f1215 0%, #1a0a0a 100%);
            display: none;
        }
        .triagem-risco.active { display: block; }
        .triagem-risco h3 { color: #fca5a5; }
        .triagem-risco .nivel {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .triagem-risco .nivel-baixo { background: #365314; color: #bef264; }
        .triagem-risco .nivel-medio { background: #713f12; color: #fde047; }
        .triagem-risco .nivel-alto { background: #7f1d1d; color: #fca5a5; }
        .triagem-risco .sinais {
            font-size: 14px;
            color: #fca5a5;
            margin-bottom: 16px;
        }
        .triagem-risco .orientacao {
            font-size: 14px;
            color: #e5e5e5;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .triagem-risco .disclaimer {
            font-size: 12px;
            color: #737373;
            font-style: italic;
        }
        .triagem-risco .recursos-apoio {
            background: rgba(127, 29, 29, 0.3);
            border: 1px solid #991b1b;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 12px 0;
        }
        .triagem-risco .recursos-titulo {
            font-size: 12px;
            font-weight: 600;
            color: #fca5a5;
            margin-bottom: 8px;
        }
        .triagem-risco .recurso-item {
            font-size: 13px;
            color: #e5e5e5;
            margin: 4px 0;
        }

        /* Response Cards - Conditional */
        .respostas-section h3 { margin-bottom: 16px; }
        .resposta-card {
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .resposta-tipo {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #737373;
            margin-bottom: 8px;
        }
        .resposta-texto {
            font-size: 14px;
            color: #e5e5e5;
            margin-bottom: 12px;
        }
        .copy-btn {
            background: transparent;
            border: 1px solid #404040;
            color: #a3a3a3;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-btn:hover { border-color: #fafafa; color: #fafafa; }
        .copy-btn.copied { border-color: #22c55e; color: #22c55e; }

        .protecao {
            text-align: center;
            padding: 24px;
            font-size: 13px;
            color: #525252;
            border-top: 1px solid #262626;
            margin-top: 32px;
        }
        .frase-ancora {
            font-weight: 500;
            font-size: 15px;
            color: #a3a3a3;
            font-style: italic;
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        .reset-btn {
            display: block;
            width: 100%;
            background: transparent;
            border: 1px solid #404040;
            color: #737373;
            padding: 14px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }
        .reset-btn:hover { border-color: #fafafa; color: #fafafa; }

        /* Feedback Form */
        .feedback-section {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 24px;
            margin-top: 32px;
        }
        .feedback-section h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #a3a3a3;
        }
        .feedback-row {
            margin-bottom: 20px;
        }
        .feedback-row label {
            display: block;
            font-size: 13px;
            color: #a3a3a3;
            margin-bottom: 8px;
        }
        .feedback-thumbs {
            display: flex;
            gap: 12px;
        }
        .thumb-btn {
            flex: 1;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .thumb-btn:hover { border-color: #404040; }
        .thumb-btn.selected { border-color: #fafafa; background: #1a1a1a; }
        .feedback-range {
            width: 100%;
            margin-top: 8px;
        }
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #525252;
            margin-top: 4px;
        }
        .feedback-textarea {
            width: 100%;
            min-height: 80px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 12px;
            color: #fafafa;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        .feedback-textarea:focus { outline: none; border-color: #525252; }
        .feedback-input {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 12px;
            color: #fafafa;
            font-family: inherit;
            font-size: 14px;
        }
        .feedback-input:focus { outline: none; border-color: #525252; }
        .feedback-submit {
            width: 100%;
            background: #262626;
            color: #fafafa;
            border: none;
            padding: 14px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .feedback-submit:hover { background: #404040; }
        .feedback-success {
            text-align: center;
            color: #22c55e;
            padding: 32px 20px;
            display: none;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
        }
        .feedback-success.active {
            display: block;
            animation: fadeInSuccess 0.3s ease;
        }
        @keyframes fadeInSuccess {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        footer { text-align: center; padding: 24px 0; font-size: 12px; color: #525252; }
        footer a { color: #737373; text-decoration: none; }
        footer a:hover { color: #fafafa; }
        .footer-logo { height: 16px; opacity: 0.4; }

        /* Legal Section */
        .legal-section {
            text-align: center;
            max-width: 500px;
            margin: 48px auto 0;
            padding: 24px;
            border-top: 1px solid #262626;
        }
        .legal-disclaimer, .legal-responsibility, .legal-privacy {
            font-size: 11px;
            color: #525252;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .legal-contact {
            font-size: 11px;
            color: #404040;
            margin-top: 16px;
        }
        .legal-contact a { color: #525252; text-decoration: none; }
        .legal-contact a:hover { color: #737373; }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 10, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading-overlay.active { display: flex; }
        .loading-text {
            font-size: 16px;
            color: #a3a3a3;
            margin-bottom: 24px;
        }
        .loading-bar {
            width: 200px;
            height: 4px;
            background: #262626;
            border-radius: 2px;
            overflow: hidden;
        }
        .loading-progress {
            height: 100%;
            background: #fafafa;
            width: 0%;
            transition: width 0.3s ease;
        }
        .loading-step {
            font-size: 12px;
            color: #525252;
            margin-top: 12px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .modal-overlay.active { display: flex; }
        .modal-wrapper { position: relative; width: 100%; max-width: 400px; }
        .modal {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
        }
        .modal h2 { font-size: 20px; font-weight: 500; margin-bottom: 8px; }
        .modal p { font-size: 14px; color: #737373; margin-bottom: 24px; }
        .modal-btn {
            width: 100%;
            background: #fafafa;
            color: #0a0a0a;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }
        .modal-btn:hover { background: #e5e5e5; }
        .modal-btn:disabled { background: #404040; color: #737373; cursor: not-allowed; }

        /* Participant Options */
        .participant-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
        .participant-option {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .participant-option:hover { border-color: #404040; }
        .participant-option.selected { border-color: #fafafa; background: #1a1a1a; }
        .participant-option input { display: none; }
        .participant-option span { font-size: 14px; }

        /* Side Options */
        .side-options { display: flex; gap: 12px; margin-bottom: 8px; }
        .side-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .side-option:hover { border-color: #404040; }
        .side-option:has(input:checked) { border-color: #fafafa; background: #1a1a1a; }
        .side-option input { display: none; }
        .side-option span { font-size: 14px; }

        /* Clarification Questions */
        .clarification-questions { display: flex; flex-direction: column; gap: 16px; margin-bottom: 8px; text-align: left; }
        .clarification-q { font-size: 14px; color: #a3a3a3; margin-bottom: 8px; }
        .clarification-opts { display: flex; gap: 12px; }
        .clarification-opt {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 10px;
            font-size: 13px;
            color: #a3a3a3;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .clarification-opt:hover { border-color: #404040; }
        .clarification-opt.selected { border-color: #fafafa; color: #fafafa; background: #1a1a1a; }
    </style>
</head>
<body>
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('pt')">PT</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
    </div>

    <div class="container">
        <header>
            <p class="brand">LOLA LAB</p>
            <h1 class="logo">Alpha</h1>
            <p class="subtitle" id="subtitle">Diagn√≥stico emocional</p>
        </header>

        <main>
            <div id="inputArea">
                <!-- Input Mode Toggle -->
                <div class="input-mode-toggle">
                    <button class="mode-btn active" id="textModeBtn" onclick="setInputMode('text')">
                        <span class="icon">üìù</span>
                        <span class="label" data-i18n="textModeLabel">Colar texto</span>
                        <span class="hint" data-i18n="textModeHint">r√°pido</span>
                    </button>
                    <button class="mode-btn" id="imageModeBtn" onclick="setInputMode('image')">
                        <span class="icon">üì∑</span>
                        <span class="label" data-i18n="imageModeLabel">Enviar prints</span>
                        <span class="hint" data-i18n="imageModeHint">mais f√°cil</span>
                    </button>
                </div>

                <!-- Text Input -->
                <div class="input-section text-input-wrapper" id="textInputWrapper">
                    <label id="inputLabel">Cole a conversa abaixo</label>
                    <textarea id="conversation" placeholder=""></textarea>
                    <p class="microcopy" data-i18n="textMicrocopy">Cole como vier. A gente organiza.</p>
                </div>

                <!-- Image Upload -->
                <div class="upload-area" id="uploadArea">
                    <input type="file" class="upload-input" id="imageInput" accept="image/*" multiple>
                    <div class="upload-icon">üì∑</div>
                    <p class="upload-text" data-i18n="uploadText">Clique ou arraste at√© 10 prints</p>
                    <p class="upload-hint" data-i18n="uploadHint">Imagens n√£o s√£o armazenadas ap√≥s an√°lise.</p>
                    <div class="upload-preview" id="uploadPreview"></div>
                </div>

                <!-- Context Section -->
                <div class="context-section">
                    <h4 data-i18n="contextTitle">Contexto r√°pido</h4>

                    <div class="context-field">
                        <label data-i18n="objectiveLabel">Objetivo da an√°lise *</label>
                        <div class="context-options" data-context="objective">
                            <span class="context-option" data-value="interesse" data-i18n="objInteresse">Saber se h√° interesse</span>
                            <span class="context-option" data-value="reciprocidade" data-i18n="objReciprocidade">Avaliar reciprocidade</span>
                            <span class="context-option" data-value="evasao" data-i18n="objEvasao">Identificar evas√£o</span>
                            <span class="context-option" data-value="insistir" data-i18n="objInsistir">Decidir: insistir ou recuar</span>
                            <span class="context-option" data-value="redflags" data-i18n="objRedflags">Detectar red flags</span>
                        </div>
                    </div>

                    <div class="context-field">
                        <label data-i18n="relationLabel">Tipo de v√≠nculo</label>
                        <div class="context-options" data-context="relationType">
                            <span class="context-option" data-value="ficante" data-i18n="relationFicante">Ficante</span>
                            <span class="context-option" data-value="dates" data-i18n="relationDates">Dates / conhecendo</span>
                            <span class="context-option" data-value="indefinido" data-i18n="relationIndefinido">Relacionamento indefinido</span>
                            <span class="context-option" data-value="namoro" data-i18n="relationNamoro">Namoro / relacionamento</span>
                        </div>
                    </div>

                    <div class="context-field">
                        <label data-i18n="platformLabel">Plataforma <span style="color:#737373">(opcional)</span></label>
                        <div class="context-options" data-context="platform">
                            <span class="context-option" data-value="whatsapp" data-i18n="platformWhatsapp">WhatsApp</span>
                            <span class="context-option" data-value="instagram" data-i18n="platformInstagram">Instagram DM</span>
                            <span class="context-option" data-value="bumble" data-i18n="platformBumble">Bumble</span>
                            <span class="context-option" data-value="tinder" data-i18n="platformTinder">Tinder</span>
                        </div>
                    </div>

                    <div class="context-field">
                        <label data-i18n="initiativeLabel">Quem puxa mais a rela√ß√£o</label>
                        <div class="context-options" data-context="initiative">
                            <span class="context-option" data-value="eu" data-i18n="initiativeMe">Eu</span>
                            <span class="context-option" data-value="outra" data-i18n="initiativeOther">Outra pessoa</span>
                            <span class="context-option" data-value="equilibrado" data-i18n="initiativeBalanced">Equilibrado</span>
                            <span class="context-option" data-value="dificil" data-i18n="initiativeHard">Dif√≠cil dizer</span>
                        </div>
                    </div>

                    <div class="context-field">
                        <label data-i18n="frequencyLabel">Frequ√™ncia real de encontros</label>
                        <div class="context-options" data-context="frequency">
                            <span class="context-option" data-value="nunca" data-i18n="freqNever">Nunca</span>
                            <span class="context-option" data-value="raramente" data-i18n="freqRarely">Raramente</span>
                            <span class="context-option" data-value="mensal" data-i18n="freqMonthly">1x m√™s ou menos</span>
                            <span class="context-option" data-value="semanal" data-i18n="freqWeekly">1x semana</span>
                            <span class="context-option" data-value="varias" data-i18n="freqSeveral">V√°rias vezes/semana</span>
                            <span class="context-option" data-value="diaria" data-i18n="freqDaily">Conviv√™ncia di√°ria</span>
                        </div>
                    </div>

                    <div class="context-field">
                        <label data-i18n="emotionalLabel">Estado emocional agora <span style="color:#737373">(opcional)</span></label>
                        <div class="context-options" data-context="emotional">
                            <span class="context-option" data-value="confusa" data-i18n="emotionalConfused">Confusa</span>
                            <span class="context-option" data-value="ansiosa" data-i18n="emotionalAnxious">Ansiosa</span>
                            <span class="context-option" data-value="cansada" data-i18n="emotionalTired">Cansada</span>
                            <span class="context-option" data-value="tranquila" data-i18n="emotionalCalm">Tranquila</span>
                            <span class="context-option" data-value="indiferente" data-i18n="emotionalIndifferent">Indiferente</span>
                        </div>
                    </div>
                </div>

                <div id="error" class="error-msg"></div>
                <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysisFlow()">Analisar</button>
            </div>

            <div id="results" class="results">
                <!-- Abuse/Risk Screening - Only shows if detected -->
                <div class="result-block triagem-risco" id="triagemRisco">
                    <h3><span class="emoji">üßØ</span> <span data-i18n="screeningTitle">Sinais na conversa (triagem)</span></h3>
                    <div class="nivel" id="nivelRisco"></div>
                    <p class="sinais" id="sinaisDetectados"></p>
                    <div class="orientacao" id="orientacaoSegura"></div>
                    <div class="recursos-apoio" id="recursosApoio">
                        <p class="recursos-titulo" data-i18n="supportTitle">Recursos de apoio:</p>
                        <p class="recurso-item">üìû <strong>CVV:</strong> 188 (24h, gratuito)</p>
                        <p class="recurso-item">üìû <strong>Ligue 180:</strong> Central de Atendimento √† Mulher</p>
                    </div>
                    <p class="disclaimer" data-i18n="screeningDisclaimer">ALPHA n√£o substitui apoio profissional. Se houver risco, priorize sua seguran√ßa.</p>
                </div>

                <!-- Main Output -->
                <div class="result-block diagnostico-central">
                    <h3><span class="emoji">üìå</span> <span data-i18n="diagTitle">Diagn√≥stico Central</span></h3>
                    <p id="diagnosticoCentral"></p>
                </div>

                <div class="result-block">
                    <h3><span class="emoji">üîÅ</span> <span data-i18n="patternTitle">Padr√£o Recorrente</span></h3>
                    <p id="padraoRecorrente"></p>
                </div>

                <div class="result-block risco-real">
                    <h3><span class="emoji">‚ö†Ô∏è</span> <span data-i18n="riskTitle">Risco Real</span></h3>
                    <p id="riscoReal"></p>
                </div>

                <div class="result-block proximo-movimento">
                    <h3><span class="emoji">üëâ</span> <span data-i18n="moveTitle">Pr√≥ximo Movimento Recomendado</span></h3>
                    <p id="proximoMovimento"></p>
                </div>

                <!-- Conditional Responses -->
                <div class="result-block respostas-section" id="respostasSection">
                    <h3 data-i18n="responsesTitle">Respostas Sugeridas</h3>
                    <div id="respostasContainer"></div>
                </div>

                <p class="protecao" id="protecaoTexto">Voc√™ n√£o est√° errada por querer clareza. Quem quer estar, encontra um jeito de ser claro.</p>
                <p class="protecao frase-ancora" id="fraseAncora">O problema n√£o √© falta de sinais. √â excesso de sinais que nunca viram a√ß√£o.</p>

                <!-- Feedback Form -->
                <div class="feedback-section" id="feedbackSection">
                    <h4 data-i18n="feedbackTitle">Ajude a melhorar o Alpha</h4>
                    <form name="alpha-feedback" method="POST" data-netlify="true" id="feedbackForm">
                        <input type="hidden" name="form-name" value="alpha-feedback">
                        <input type="hidden" name="pattern" id="feedbackPattern">
                        <input type="hidden" name="lang" id="feedbackLang">

                        <div class="feedback-row">
                            <label data-i18n="feedbackHelpful">Isso te ajudou?</label>
                            <div class="feedback-thumbs">
                                <button type="button" class="thumb-btn" data-value="yes" onclick="selectThumb(this)">üëç</button>
                                <button type="button" class="thumb-btn" data-value="no" onclick="selectThumb(this)">üëé</button>
                            </div>
                            <input type="hidden" name="helpful" id="feedbackHelpful">
                        </div>

                        <div class="feedback-row">
                            <label data-i18n="feedbackAccuracy">O qu√£o certeiro foi? (0-10)</label>
                            <input type="range" class="feedback-range" name="accuracy" min="0" max="10" value="5" id="feedbackAccuracy">
                            <div class="range-labels">
                                <span>0</span>
                                <span>5</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="feedback-row">
                            <label data-i18n="feedbackConfused">O que ficou confuso?</label>
                            <textarea class="feedback-textarea" name="confused" placeholder=""></textarea>
                        </div>

                        <div class="feedback-row">
                            <label data-i18n="feedbackWanted">O que voc√™ gostaria que tivesse?</label>
                            <textarea class="feedback-textarea" name="wanted" placeholder=""></textarea>
                        </div>

                        <div class="feedback-row">
                            <label data-i18n="feedbackEmail">E-mail (opcional)</label>
                            <input type="email" class="feedback-input" name="email" placeholder="">
                        </div>

                        <button type="submit" class="feedback-submit" data-i18n="feedbackSubmit">Enviar feedback</button>
                    </form>
                    <div class="feedback-success" id="feedbackSuccess">
                        <p data-i18n="feedbackThanks">‚úì Obrigada pelo feedback!</p>
                    </div>
                </div>

                <button class="reset-btn" onclick="resetAnalysis()" id="resetBtn">Analisar outra conversa</button>
            </div>
        </main>

        <footer>
            <img src="logo-lolalab.svg" alt="LolaLab" class="footer-logo">
        </footer>
    </div>

    <!-- Modal: Quem √© voc√™ na conversa? -->
    <div class="modal-overlay" id="participantModal">
        <div class="modal-wrapper">
            <div class="modal">
                <h2 data-i18n="participantTitle">Quem √© voc√™ na conversa?</h2>
                <p data-i18n="participantDesc">Detectamos nomes na conversa. Selecione qual √© voc√™:</p>
                <div id="participantOptions" class="participant-options"></div>
                <button class="modal-btn" onclick="confirmParticipant()" data-i18n="participantConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Lado das mensagens (prints) -->
    <div class="modal-overlay" id="sideModal">
        <div class="modal-wrapper">
            <div class="modal">
                <h2 data-i18n="sideTitle">Suas mensagens est√£o em qual lado?</h2>
                <p data-i18n="sideDesc">Nos prints, onde aparecem suas mensagens?</p>
                <div class="side-options">
                    <label class="side-option">
                        <input type="radio" name="messageSide" value="right">
                        <span data-i18n="sideRight">‚û°Ô∏è Direita</span>
                    </label>
                    <label class="side-option">
                        <input type="radio" name="messageSide" value="left">
                        <span data-i18n="sideLeft">‚¨ÖÔ∏è Esquerda</span>
                    </label>
                </div>
                <button class="modal-btn" onclick="confirmSide()" data-i18n="sideConfirm">Continuar an√°lise</button>
            </div>
        </div>
    </div>

    <!-- Modal: Pouco hist√≥rico -->
    <div class="modal-overlay" id="lowHistoryModal">
        <div class="modal-wrapper">
            <div class="modal">
                <h2 data-i18n="lowHistoryTitle">Pouco hist√≥rico detectado</h2>
                <p data-i18n="lowHistoryDesc">A conversa tem poucas mensagens. Responda para melhorar a an√°lise:</p>
                <div class="clarification-questions" id="clarificationQuestions"></div>
                <button class="modal-btn" onclick="submitClarifications()" data-i18n="lowHistorySubmit">Ver an√°lise</button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" id="loadingOverlay">
        <p class="loading-text" data-i18n="loadingText">Analisando conversa...</p>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <p class="loading-step" id="loadingStep" data-i18n="loadingStep">Identificando padr√µes</p>
    </div>

    <script>
        let currentLang = 'pt';
        let inputMode = 'text';
        let uploadedImages = [];
        let contextValues = { objective: null, relationType: null, platform: null, initiative: null, frequency: null, emotional: null };
        let detectedPattern = '';

        // Analysis state variables (global scope)
        let analysisState = { step: 'initial', text: '', lowHistory: false };
        let detectedParticipants = [];
        let selectedParticipant = null;
        let messageSide = null;
        let clarificationAnswers = { q1: null, q2: null, q3: null };

        const i18n = {
            pt: {
                subtitle: 'Diagn√≥stico emocional',
                textModeLabel: 'Colar texto',
                textModeHint: 'r√°pido',
                imageModeLabel: 'Enviar prints',
                imageModeHint: 'mais f√°cil',
                inputLabel: 'Cole a conversa abaixo',
                placeholder: 'Cole aqui a conversa que voc√™ quer analisar...',
                textMicrocopy: 'Cole como vier. A gente organiza.',
                uploadText: 'Clique ou arraste at√© 10 prints',
                uploadHint: 'Imagens n√£o s√£o armazenadas ap√≥s an√°lise.',
                contextTitle: 'Contexto r√°pido',
                objectiveLabel: 'Objetivo da an√°lise *',
                objInteresse: 'Saber se h√° interesse',
                objReciprocidade: 'Avaliar reciprocidade',
                objEvasao: 'Identificar evas√£o',
                objInsistir: 'Decidir: insistir ou recuar',
                objRedflags: 'Detectar red flags',
                relationLabel: 'Tipo de v√≠nculo',
                relationFicante: 'Ficante',
                relationDates: 'Dates / conhecendo',
                relationIndefinido: 'Relacionamento indefinido',
                relationNamoro: 'Namoro / relacionamento',
                platformLabel: 'Plataforma',
                platformWhatsapp: 'WhatsApp',
                platformInstagram: 'Instagram DM',
                platformBumble: 'Bumble',
                platformTinder: 'Tinder',
                initiativeLabel: 'Quem puxa mais a rela√ß√£o',
                initiativeMe: 'Eu',
                initiativeOther: 'Outra pessoa',
                initiativeBalanced: 'Equilibrado',
                initiativeHard: 'Dif√≠cil dizer',
                frequencyLabel: 'Frequ√™ncia real de encontros',
                freqNever: 'Nunca',
                freqRarely: 'Raramente',
                freqMonthly: '1x m√™s ou menos',
                freqWeekly: '1x semana',
                freqSeveral: 'V√°rias vezes/semana',
                freqDaily: 'Conviv√™ncia di√°ria',
                emotionalLabel: 'Estado emocional agora',
                emotionalConfused: 'Confusa',
                emotionalAnxious: 'Ansiosa',
                emotionalTired: 'Cansada',
                emotionalCalm: 'Tranquila',
                emotionalIndifferent: 'Indiferente',
                analyzeBtn: 'Analisar',
                errorEmpty: 'Cole a conversa ou envie prints para come√ßar.',
                errorShort: 'Cole uma conversa mais completa ou envie mais prints.',
                errorNoDoubt: 'Selecione o objetivo da an√°lise.',
                diagTitle: 'Diagn√≥stico Central',
                patternTitle: 'Padr√£o Recorrente',
                riskTitle: 'Risco Real',
                moveTitle: 'Pr√≥ximo Movimento Recomendado',
                responsesTitle: 'Respostas Sugeridas',
                copyBtn: 'Copiar',
                copiedBtn: 'Copiado',
                resetBtn: 'Analisar outra conversa',
                protecao: 'Voc√™ n√£o est√° errada por querer clareza. Quem quer estar, encontra um jeito de ser claro.',
                fraseAncora: 'O problema n√£o √© falta de sinais. √â excesso de sinais que nunca viram a√ß√£o.',
                screeningTitle: 'Sinais na conversa (triagem)',
                screeningDisclaimer: 'Alpha n√£o substitui apoio profissional. Se houver risco, priorize seguran√ßa e apoio.',
                nivelBaixo: 'Baixo',
                nivelMedio: 'M√©dio',
                nivelAlto: 'Alto',
                feedbackTitle: 'Ajude a melhorar o Alpha',
                feedbackHelpful: 'Isso te ajudou?',
                feedbackAccuracy: 'O qu√£o certeiro foi? (0-10)',
                feedbackConfused: 'O que ficou confuso?',
                feedbackWanted: 'O que voc√™ gostaria que tivesse?',
                feedbackEmail: 'E-mail (opcional)',
                feedbackSubmit: 'Enviar feedback',
                feedbackThanks: '‚úì Obrigada. Seu feedback ajuda a melhorar o Alpha.',
                footerDisclaimer: 'Para fins de entretenimento. N√£o substitui acompanhamento profissional.',
                // Modals
                participantTitle: 'Quem √© voc√™ na conversa?',
                participantDesc: 'Detectamos nomes na conversa. Selecione qual √© voc√™:',
                participantConfirm: 'Confirmar',
                participantOther: 'Outro (n√£o listado)',
                sideTitle: 'Suas mensagens est√£o em qual lado?',
                sideDesc: 'Nos prints, onde aparecem suas mensagens?',
                sideRight: '‚û°Ô∏è Direita',
                sideLeft: '‚¨ÖÔ∏è Esquerda',
                sideConfirm: 'Continuar an√°lise',
                lowHistoryTitle: 'Leitura inicial (baixa confian√ßa)',
                lowHistoryDesc: 'A conversa tem poucas mensagens. Responda para melhorar a an√°lise:',
                lowHistorySubmit: 'Ver an√°lise',
                clarQ1: 'Voc√™ costuma iniciar a maioria das conversas?',
                clarQ2: 'A pessoa j√° desmarcou/adiou planos mais de uma vez?',
                clarQ3: 'Voc√™ sente que est√° mais investida do que a outra pessoa?',
                clarYes: 'Sim',
                clarNo: 'N√£o',
                // Loading
                loadingText: 'Analisando conversa...',
                loadingStep: 'Identificando padr√µes',
                loadingStep2: 'Calculando scores',
                loadingStep3: 'Gerando diagn√≥stico',
                // Legal
                legalDisclaimer: 'Este relat√≥rio √© uma an√°lise estat√≠stica de padr√µes de comunica√ß√£o e n√£o constitui aconselhamento psicol√≥gico ou m√©dico.',
                legalResponsibility: 'As decis√µes tomadas a partir deste relat√≥rio s√£o de responsabilidade exclusiva da usu√°ria.',
                legalPrivacy: 'Seus dados s√£o processados localmente e n√£o s√£o armazenados em nossos servidores.',
                supportTitle: 'Recursos de apoio:'
            },
            en: {
                subtitle: 'Emotional diagnosis',
                textModeLabel: 'Paste text',
                textModeHint: 'fast',
                imageModeLabel: 'Upload screenshots',
                imageModeHint: 'easier',
                inputLabel: 'Paste the conversation below',
                placeholder: 'Paste the conversation you want to analyze here...',
                textMicrocopy: 'Paste as is. We\'ll organize it.',
                uploadText: 'Click or drag up to 10 screenshots',
                uploadHint: 'Images aren\'t stored after analysis.',
                contextTitle: 'Quick context',
                objectiveLabel: 'Analysis objective *',
                objInteresse: 'Check if there is interest',
                objReciprocidade: 'Evaluate reciprocity',
                objEvasao: 'Identify avoidance',
                objInsistir: 'Decide: push or pull back',
                objRedflags: 'Detect red flags',
                relationLabel: 'Type of bond',
                relationFicante: 'Casual / hookup',
                relationDates: 'Dating / getting to know',
                relationIndefinido: 'Undefined relationship',
                relationNamoro: 'Committed relationship',
                platformLabel: 'Platform',
                platformWhatsapp: 'WhatsApp',
                platformInstagram: 'Instagram DM',
                platformBumble: 'Bumble',
                platformTinder: 'Tinder',
                initiativeLabel: 'Who drives the relationship more',
                initiativeMe: 'Me',
                initiativeOther: 'Other person',
                initiativeBalanced: 'Balanced',
                initiativeHard: 'Hard to say',
                frequencyLabel: 'Real meeting frequency',
                freqNever: 'Never',
                freqRarely: 'Rarely',
                freqMonthly: '1x month or less',
                freqWeekly: '1x week',
                freqSeveral: 'Several times/week',
                freqDaily: 'Daily contact',
                emotionalLabel: 'Emotional state now',
                emotionalConfused: 'Confused',
                emotionalAnxious: 'Anxious',
                emotionalTired: 'Tired',
                emotionalCalm: 'Calm',
                emotionalIndifferent: 'Indifferent',
                analyzeBtn: 'Analyze',
                errorEmpty: 'Paste the conversation or upload screenshots to start.',
                errorShort: 'Paste a more complete conversation or upload more screenshots.',
                errorNoDoubt: 'Select the analysis objective.',
                diagTitle: 'Central Diagnosis',
                patternTitle: 'Recurring Pattern',
                riskTitle: 'Real Risk',
                moveTitle: 'Recommended Next Move',
                responsesTitle: 'Suggested Responses',
                copyBtn: 'Copy',
                copiedBtn: 'Copied',
                resetBtn: 'Analyze another conversation',
                protecao: 'You\'re not wrong for wanting clarity. Those who want to be present find a way to be clear.',
                fraseAncora: 'The issue isn\'t lack of signals. It\'s signals that never turn into action.',
                screeningTitle: 'Conversation signs (screening)',
                screeningDisclaimer: 'Alpha does not replace professional support. If there\'s risk, prioritize safety and support.',
                nivelBaixo: 'Low',
                nivelMedio: 'Medium',
                nivelAlto: 'High',
                feedbackTitle: 'Help improve Alpha',
                feedbackHelpful: 'Did this help you?',
                feedbackAccuracy: 'How accurate was it? (0-10)',
                feedbackConfused: 'What was confusing?',
                feedbackWanted: 'What would you have liked to see?',
                feedbackEmail: 'Email (optional)',
                feedbackSubmit: 'Send feedback',
                feedbackThanks: '‚úì Thank you. Your feedback helps improve Alpha.',
                footerDisclaimer: 'For entertainment purposes. Does not replace professional guidance.',
                // Modals
                participantTitle: 'Who are you in the conversation?',
                participantDesc: 'We detected names in the conversation. Select which one is you:',
                participantConfirm: 'Confirm',
                participantOther: 'Other (not listed)',
                sideTitle: 'Which side are your messages on?',
                sideDesc: 'In the screenshots, where do your messages appear?',
                sideRight: '‚û°Ô∏è Right',
                sideLeft: '‚¨ÖÔ∏è Left',
                sideConfirm: 'Continue analysis',
                lowHistoryTitle: 'Initial reading (low confidence)',
                lowHistoryDesc: 'The conversation has few messages. Answer to improve the analysis:',
                lowHistorySubmit: 'See analysis',
                clarQ1: 'Do you usually start most conversations?',
                clarQ2: 'Has the person canceled/postponed plans more than once?',
                clarQ3: 'Do you feel more invested than the other person?',
                clarYes: 'Yes',
                clarNo: 'No',
                // Loading
                loadingText: 'Analyzing conversation...',
                loadingStep: 'Identifying patterns',
                loadingStep2: 'Calculating scores',
                loadingStep3: 'Generating diagnosis',
                // Legal
                legalDisclaimer: 'This report is a statistical analysis of communication patterns and does not constitute psychological or medical advice.',
                legalResponsibility: 'Decisions made based on this report are the sole responsibility of the user.',
                legalPrivacy: 'Your data is processed locally and is not stored on our servers.',
                supportTitle: 'Support resources:'
            }
        };

        const patterns = {
            evasao: {
                pt: ['vamos ver', 'depois a gente v√™', 'n√£o sei', 'talvez', 'quem sabe', 'um dia', 'quando der', 'se der', 'n√£o estou pronto', 'preciso de tempo', 'n√£o √© o momento', 'agora n√£o d√°', 'vou pensar', 'deixa eu ver', 'n√£o posso prometer', 'n√£o sei te dizer', '√© complicado', '√© dif√≠cil', 'n√£o tenho certeza', 'pode ser', 'sei l√°', 'tanto faz', 'voc√™ decide', 'vamos ver no que d√°', 'n√£o vamos rotular'],
                en: ["let's see", "we'll see", "i don't know", 'maybe', 'perhaps', 'someday', 'when possible', 'if possible', "i'm not ready", 'i need time', "it's not the right time", "can't right now", "i'll think about it", "can't promise", "i don't know what to tell you", "it's complicated", "i'm not sure", 'could be', 'whatever', 'you decide']
            },
            assimetria: {
                pt: ['voc√™ vem', 'vem c√°', 'vem aqui', 'passa aqui', 'me visita', 'quando voc√™ pode', 'voc√™ que sabe', 'se voc√™ quiser', 'como voc√™ preferir', 'fica a seu crit√©rio', 'n√£o precisa', 'tanto faz pra mim', 'voc√™ escolhe', 'faz o que quiser'],
                en: ['you come', 'come here', 'visit me', 'when can you', 'you decide', 'if you want', 'as you prefer', 'up to you', "doesn't matter to me"]
            },
            faltaClareza: {
                pt: ['o que somos', 'onde isso vai dar', 'quero entender', 'preciso saber', 'futuro', 'pra onde', 'namoro', 'relacionamento', 'compromisso', 'exclusivo', 's√©rio', 'definir', 'clareza', 'certeza', 'insegura', 'ansiedade', 'n√£o sei onde estou', 'confusa', 'o que voc√™ quer', 'o que a gente √©'],
                en: ['what are we', 'where is this going', 'i want to understand', 'i need to know', 'future', 'relationship', 'commitment', 'exclusive', 'serious', 'define', 'clarity', 'certainty', 'insecure', 'anxiety', 'confused']
            },
            reassuranceSemAcao: {
                pt: ['gosto de voc√™', 'gosto muito', 'te adoro', 'voc√™ √© especial', 'voc√™ √© importante', 'n√£o quero te perder', 'n√£o quero que pense', 'desculpa', 'me desculpa', 'n√£o √© isso', 'voc√™ entendeu errado', 'calma', 'relaxa', 'n√£o fica assim', 'confia em mim', 'eu gosto de estar contigo', 'voc√™ sabe que gosto'],
                en: ['i like you', 'i really like you', 'i adore you', "you're special", "you're important", "i don't want to lose you", "don't think that", 'sorry', "i'm sorry", "that's not it", 'you misunderstood', 'calm down', 'relax', "don't be like that", 'trust me']
            },
            baixaReciprocidade: {
                pt: ['se quiser', 'quando quiser', 'se puder', 'quando puder', 'n√£o precisa', 'fica tranquila', 'sem press√£o', 'sem compromisso', 'a gente se fala', 'te aviso', 'depois eu falo', 'n√£o sei quando', 'qualquer dia'],
                en: ['if you want', 'whenever you want', 'if you can', 'when you can', 'no need', 'no pressure', 'no commitment', "we'll talk", "i'll let you know", "i'll tell you later"]
            },
            // NEW: Desvio sexual/humor como anest√©sico emocional
            desvioSexualHumor: {
                pt: ['brincadeira', 't√° brava', 'que drama', 'exagerada', 'neur√≥tica', 'ciumenta', 'voc√™ viaja', 'vem c√° que eu resolvo', 'vem que eu te acalmo', 'vem pro meu colo', 'deixa eu te dar um beijo', 'para de pensar nisso', 'esquece isso', 'muda de assunto', 'bora falar de outra coisa', 'saudade do seu corpo', 'quero te pegar', 't√¥ com tes√£o', 'manda foto', 'manda nude', 'quero te ver pelada'],
                en: ['just kidding', 'are you mad', 'so dramatic', 'exaggerating', 'neurotic', 'jealous', 'you\'re tripping', 'come here i\'ll fix it', 'let me calm you down', 'come to my arms', 'let me kiss you', 'stop thinking about it', 'forget it', 'change the subject', 'let\'s talk about something else', 'miss your body', 'want you', 'i\'m horny', 'send pic', 'send nudes']
            },
            // NEW: Vulnerabilidade sem a√ß√£o
            vulnerabilidadeSemAcao: {
                pt: ['eu sei que erro', 'sei que preciso melhorar', 'vou mudar', 'prometo', 'dessa vez vai ser diferente', 'me d√° mais uma chance', 'n√£o vai acontecer de novo', 'eu te amo', 'voc√™ sabe que te amo', 's√≥ preciso de tempo', 't√¥ tentando', 't√¥ me esfor√ßando', 'n√£o √© f√°cil pra mim', 'tenho medo de perder voc√™', 'voc√™ √© tudo pra mim', 'nunca amei assim', 'sei que fui errado', 'me perdoa', 'sei que machuquei voc√™'],
                en: ['i know i mess up', 'i know i need to improve', 'i\'ll change', 'i promise', 'this time will be different', 'give me another chance', 'it won\'t happen again', 'i love you', 'you know i love you', 'i just need time', 'i\'m trying', 'i\'m making an effort', 'it\'s not easy for me', 'i\'m afraid of losing you', 'you\'re everything to me', 'never loved like this', 'i know i was wrong', 'forgive me', 'i know i hurt you']
            },
            // NEW: Evas√£o elegante (frases espec√≠ficas)
            evasaoElegante: {
                pt: ['prefiro deixar fluir', 'deixa acontecer', 'n√£o vamos for√ßar', 'n√£o vamos rotular', 'o tempo dir√°', 'vai fluindo', 'sem pressa', 'vai com calma', 'a gente vai vendo', 'n√£o precisa definir', 'n√£o gosto de cobran√ßas', 'voc√™ cobra demais', 'para de pressionar', 'cada um no seu tempo', 'estou bem assim', 'n√£o precisa mudar nada'],
                en: ['let it flow', 'let it happen', 'let\'s not force it', 'let\'s not label it', 'time will tell', 'go with the flow', 'no rush', 'take it easy', 'we\'ll see as we go', 'no need to define', 'i don\'t like being pressured', 'you pressure too much', 'stop pushing', 'everyone at their own pace', 'i\'m fine like this', 'no need to change anything']
            },
            // Abuse/Risk patterns
            abuso: {
                pt: ['voc√™ √© louca', 't√° maluca', 'ningu√©m vai te querer', 'voc√™ n√£o consegue', 'sem mim voc√™ n√£o √© nada', 'a culpa √© sua', 'voc√™ me fez fazer isso', 'olha o que voc√™ me faz', 'n√£o fala com', 'n√£o pode sair', 'me mostra o celular', 'com quem voc√™ estava', 't√° me traindo', 'cuidado comigo', 'some da minha vida', 'vou contar pra todo mundo', 'ningu√©m vai acreditar', 'voc√™ √© burra', 'voc√™ √© feia', 'tenho vergonha de voc√™', 'te bater', 'vou te machucar'],
                en: ["you're crazy", 'you are crazy', 'no one will want you', "you can't do anything", "without me you're nothing", "it's your fault", 'you made me do this', 'look what you make me do', "don't talk to", "you can't go out", 'show me your phone', 'who were you with', "you're cheating", 'be careful with me', 'get out of my life', "i'll tell everyone", 'no one will believe', "you're stupid", "you're ugly", "i'm ashamed of you", 'hit you', "i'll hurt you"]
            }
        };

        // Diagnostic content
        const diagnosticos = {
            pt: {
                central: {
                    evasaoAlta: "A pessoa est√° te mantendo em modo de espera. N√£o √© confus√£o ‚Äî √© escolha.",
                    assimetriaAlta: "Voc√™ carrega a rela√ß√£o sozinha. Isso n√£o √© parceria ‚Äî √© conveni√™ncia pro outro lado.",
                    faltaClarezaAlta: "A falta de defini√ß√£o √â a defini√ß√£o. O sil√™ncio dele j√° √© a resposta.",
                    baixaReciprocidadeAlta: "Voc√™ d√°, o outro recebe. Essa equa√ß√£o n√£o fecha em nenhum cen√°rio saud√°vel.",
                    desvioSexualHumorAlto: "Toda vez que voc√™ tenta aprofundar, ele desvia com sexo ou humor. Isso √© anest√©sico emocional, n√£o equil√≠brio.",
                    vulnerabilidadeSemAcaoAlta: "Vulnerabilidade verbal sem mudan√ßa de comportamento n√£o √© avan√ßo ‚Äî √© estagna√ß√£o emocional.",
                    evasaoEleganteAlta: "'Deixa fluir' √© a vers√£o polida de 'n√£o quero me comprometer'. A porta de sa√≠da segue aberta.",
                    misto: "Evas√£o + assimetria: voc√™ busca, o outro recua. Esse padr√£o n√£o muda sozinho.",
                    saudavel: "Essa rela√ß√£o parece saud√°vel. N√£o identificamos padr√µes de risco ou desgaste emocional.",
                    // AMIZADE
                    amizadeDistante: "A amizade parece ter esfriado. Pode ser fase, pode ser afastamento natural. Vale observar sem press√£o.",
                    amizadeDesigual: "Voc√™ parece puxar mais a amizade do que ela. Isso n√£o significa que n√£o gosta de voc√™ ‚Äî pode ser fase, rotina ou estilo diferente de se relacionar.",
                    amizadeSaudavel: "Essa amizade parece genu√≠na. A troca flui sem for√ßar, e isso √© raro. Cuide dela.",
                    amizadeDuvidosa: "√â dif√≠cil saber se algu√©m √© amigo de verdade s√≥ por mensagens. Amizade se prova no tempo e nas a√ß√µes, n√£o nas palavras.",
                    // FAM√çLIA
                    familiaDistante: "Dist√¢ncia familiar pode doer, mas geralmente √© sobre limites, n√£o rejei√ß√£o. D√™ espa√ßo sem ressentimento.",
                    familiaDesigual: "Din√¢micas familiares s√£o complexas. N√≠veis diferentes de esfor√ßo s√£o comuns ‚Äî nem sempre √© sobre amor.",
                    familiaSaudavel: "Essa conex√£o familiar parece equilibrada. V√≠nculos saud√°veis se constroem com respeito, n√£o obriga√ß√£o.",
                    familiaDificil: "Rela√ß√µes familiares carregam hist√≥ria. Uma conversa n√£o mostra o quadro todo.",
                    // TRABALHO
                    trabalhoProfissional: "Isso parece comunica√ß√£o profissional. Mantenha limites claros ‚Äî rela√ß√µes de trabalho n√£o s√£o pessoais.",
                    trabalhoDesigual: "Din√¢micas de poder no trabalho s√£o normais. N√£o confunda dist√¢ncia profissional com rejei√ß√£o pessoal.",
                    trabalhoSaudavel: "Rela√ß√£o profissional com bons limites. Mantenha assim.",
                    trabalhoComplicado: "Rela√ß√µes de trabalho podem ser complicadas. Mantenha profissionalismo e n√£o invista emocionalmente em excesso."
                },
                padrao: {
                    evasaoAlta: "Frases vagas recorrentes: 'vamos ver', 'n√£o sei', 'quando der'. Cada uma √© uma porta de sa√≠da mantida aberta.",
                    assimetriaAlta: "O esfor√ßo vem sempre do mesmo lado. Iniciativa, deslocamento, disponibilidade ‚Äî tudo seu.",
                    faltaClarezaAlta: "Pedidos de clareza s√£o respondidos com mais ambiguidade. Isso √© circular e intencional.",
                    baixaReciprocidadeAlta: "Disponibilidade passiva: 'se voc√™ quiser', 'quando puder'. Quem quer, age. Quem n√£o quer, espera.",
                    desvioSexualHumorAlto: "Tentativas de aprofundar s√£o seguidas de piadas, sexualiza√ß√£o ou mudan√ßa de assunto. O desvio emocional √© sistem√°tico.",
                    vulnerabilidadeSemAcaoAlta: "Pedidos de desculpa, promessas de mudan√ßa, declara√ß√µes de amor ‚Äî mas o comportamento permanece igual. Vulnerabilidade perform√°tica.",
                    evasaoEleganteAlta: "'Prefiro deixar fluir', 'n√£o vamos rotular', 'cada um no seu tempo'. Evas√£o disfar√ßada de maturidade emocional.",
                    misto: "Palavras bonitas sem a√ß√£o correspondente. Carinho verbal que nunca vira compromisso real.",
                    saudavel: "A comunica√ß√£o flui bem. H√° reciprocidade e respeito m√∫tuo na troca.",
                    // AMIZADE
                    amizadeDistante: "Respostas mais curtas, menos iniciativa, menos disponibilidade. Pode ser s√≥ momento de vida.",
                    amizadeDesigual: "Voc√™ parece investir mais tempo e energia na amizade. Pode ser diferen√ßa de estilo, n√£o necessariamente falta de carinho.",
                    amizadeSaudavel: "Humor, leveza, reciprocidade. Voc√™s se entendem sem precisar explicar muito.",
                    amizadeDuvidosa: "Amizade √© constru√≠da com consist√™ncia. Uma conversa n√£o mostra o quadro todo.",
                    // FAM√çLIA
                    familiaDistante: "Menos contato, respostas pragm√°ticas. Pode ser prote√ß√£o emocional, n√£o necessariamente falta de amor.",
                    familiaDesigual: "A fam√≠lia nem sempre demonstra afeto da mesma forma. Gera√ß√µes diferentes, linguagens diferentes.",
                    familiaSaudavel: "Respeito m√∫tuo, mesmo com diferen√ßas. Isso √© maturidade familiar.",
                    familiaDificil: "Padr√µes familiares s√£o dif√≠ceis de mudar. Observe o contexto maior, n√£o s√≥ uma conversa.",
                    // TRABALHO
                    trabalhoProfissional: "Tom formal, objetividade. Isso √© profissionalismo, n√£o frieza.",
                    trabalhoDesigual: "Hierarquias criam dist√¢ncia natural. N√£o personalize o que √© estrutural.",
                    trabalhoSaudavel: "Comunica√ß√£o clara e respeitosa. Bons limites profissionais.",
                    trabalhoComplicado: "Mistura de pessoal e profissional. Cuidado com expectativas fora do contexto de trabalho."
                },
                risco: {
                    evasaoAlta: "Voc√™ vai continuar investindo energia em algo que n√£o evolui. Meses v√£o passar e nada vai mudar.",
                    assimetriaAlta: "Voc√™ vai se esgotar mantendo algo que o outro n√£o sustenta. Desequil√≠brio cr√¥nico destr√≥i autoestima.",
                    faltaClarezaAlta: "O limbo emocional vai gerar ansiedade constante. Voc√™ merece clareza, n√£o adivinha√ß√£o.",
                    baixaReciprocidadeAlta: "Voc√™ vai normalizar receber menos do que d√°. Isso recalibra seu padr√£o pra baixo.",
                    desvioSexualHumorAlto: "Voc√™ vai continuar tentando conex√£o emocional e sendo redirecionada para superficialidade. Exaust√£o garantida.",
                    vulnerabilidadeSemAcaoAlta: "Voc√™ vai ficar presa no ciclo de 'dessa vez vai ser diferente'. Esperan√ßa sem evid√™ncia.",
                    evasaoEleganteAlta: "Voc√™ vai aceitar a indefini√ß√£o como normalidade. O 'fluxo' √© unilateral ‚Äî s√≥ beneficia quem evita compromisso.",
                    misto: "Quanto mais voc√™ tenta, mais o outro se acomoda. O ciclo s√≥ quebra quando voc√™ para.",
                    saudavel: "Rela√ß√£o equilibrada. Continue cultivando essa conex√£o com presen√ßa e honestidade.",
                    // AMIZADE
                    amizadeDistante: "For√ßar proximidade pode afastar ainda mais. Deixe a amizade respirar.",
                    amizadeDesigual: "Amizades passam por fases. N√£o tire conclus√µes definitivas por um momento.",
                    amizadeSaudavel: "Nenhum risco identificado. Amizades leves s√£o valiosas ‚Äî n√£o complique.",
                    amizadeDuvidosa: "O risco √© criar expectativas irreais. Deixe o tempo mostrar quem essa pessoa √©.",
                    // FAM√çLIA
                    familiaDistante: "For√ßar aproxima√ß√£o pode criar mais resist√™ncia. Respeite o tempo do outro.",
                    familiaDesigual: "Cobrar reciprocidade de fam√≠lia pode gerar mais conflito. Aceite as limita√ß√µes.",
                    familiaSaudavel: "Nenhum risco identificado. Rela√ß√µes familiares saud√°veis s√£o raras ‚Äî valorize.",
                    familiaDificil: "O risco √© repetir padr√µes antigos. Quebre o ciclo com limites saud√°veis.",
                    // TRABALHO
                    trabalhoProfissional: "Nenhum risco identificado. Mantenha a rela√ß√£o no contexto profissional.",
                    trabalhoDesigual: "O risco √© levar para o pessoal o que √© estrutural. Mantenha perspectiva.",
                    trabalhoSaudavel: "Nenhum risco. Continue mantendo limites claros.",
                    trabalhoComplicado: "O risco √© misturar expectativas pessoais com profissionais. Defina limites."
                },
                movimento: {
                    evasaoAlta: "Fa√ßa UMA pergunta direta: 'Voc√™ quer construir algo comigo, sim ou n√£o?' Aceite a resposta ‚Äî inclusive o sil√™ncio.",
                    assimetriaAlta: "Pare de iniciar por 2 semanas. Observe quem sustenta a rela√ß√£o quando voc√™ recua. A resposta estar√° clara.",
                    faltaClarezaAlta: "Verbalize: 'Preciso de clareza pra continuar.' Defina prazo interno. N√£o d√™ mais chances sem a√ß√£o concreta.",
                    baixaReciprocidadeAlta: "Reduza disponibilidade. Quem sente sua aus√™ncia, busca. Quem n√£o sente, j√° te deu a resposta.",
                    desvioSexualHumorAlto: "Pr√≥xima vez que desviar: 'Prefiro resolver o que est√° pendente antes de continuar nesse tom.' N√£o aceite a mudan√ßa de assunto.",
                    vulnerabilidadeSemAcaoAlta: "Pare de ouvir promessas. Diga: 'N√£o preciso de palavras, preciso de mudan√ßa. Me mostra com a√ß√£o.' Defina prazo interno.",
                    evasaoEleganteAlta: "Confronte a evas√£o disfar√ßada: 'Fluir pra onde? Preciso saber se isso tem futuro ou estou perdendo tempo.'",
                    misto: "√öltima tentativa direta. Se a resposta for vaga, encerre com respeito. Voc√™ j√° fez sua parte.",
                    saudavel: "Aproveite o que est√° funcionando. Rela√ß√µes boas merecem ser nutridas, n√£o analisadas em excesso.",
                    // AMIZADE
                    amizadeDistante: "D√™ espa√ßo. Se a amizade for real, ela volta naturalmente. Se n√£o voltar, voc√™ tem sua resposta.",
                    amizadeDesigual: "Pare de puxar por um tempo. Observe se ela vem at√© voc√™. Amizade verdadeira n√£o precisa de esfor√ßo constante.",
                    amizadeSaudavel: "Continue sendo presente. Amizades boas s√£o raras ‚Äî valorize essa.",
                    amizadeDuvidosa: "Observe as a√ß√µes ao longo do tempo, n√£o s√≥ as palavras. Amizade verdadeira se prova nos momentos dif√≠ceis.",
                    // FAM√çLIA
                    familiaDistante: "Mantenha a porta aberta sem for√ßar. Fam√≠lia tem seu pr√≥prio tempo.",
                    familiaDesigual: "Aceite que nem todos expressam amor da mesma forma. Foque no que est√° ao seu alcance.",
                    familiaSaudavel: "Continue cultivando essa conex√£o. Fam√≠lia saud√°vel √© base de tudo.",
                    familiaDificil: "Proteja sua paz. Voc√™ pode amar de longe se necess√°rio.",
                    // TRABALHO
                    trabalhoProfissional: "Mantenha profissionalismo. N√£o misture expectativas pessoais.",
                    trabalhoDesigual: "Foque no seu trabalho, n√£o nas din√¢micas de poder. Entregue resultados.",
                    trabalhoSaudavel: "Continue assim. Boas rela√ß√µes de trabalho facilitam tudo.",
                    trabalhoComplicado: "Estabele√ßa limites claros. Trabalho √© trabalho, pessoal √© pessoal."
                }
            },
            en: {
                central: {
                    evasaoAlta: "They're keeping you on hold. This isn't confusion ‚Äî it's a choice.",
                    assimetriaAlta: "You're carrying the relationship alone. This isn't partnership ‚Äî it's convenience for them.",
                    faltaClarezaAlta: "The lack of definition IS the definition. Their silence is already the answer.",
                    baixaReciprocidadeAlta: "You give, they take. This equation doesn't work in any healthy scenario.",
                    desvioSexualHumorAlto: "Every time you try to go deeper, they deflect with sex or humor. This is emotional numbing, not balance.",
                    vulnerabilidadeSemAcaoAlta: "Verbal vulnerability without behavior change isn't progress ‚Äî it's emotional stagnation.",
                    evasaoEleganteAlta: "'Let it flow' is the polished version of 'I don't want to commit'. The exit door remains open.",
                    misto: "Avoidance + asymmetry: you seek, they retreat. This pattern doesn't change on its own.",
                    saudavel: "This relationship appears healthy. No patterns of risk or emotional strain detected.",
                    // FRIENDSHIP
                    amizadeDistante: "The friendship seems to have cooled off. Could be a phase, could be natural drifting. Worth observing without pressure.",
                    amizadeDesigual: "You seem to put more effort into the friendship. This doesn't mean they don't care ‚Äî could be their phase, routine, or different relating style.",
                    amizadeSaudavel: "This friendship seems genuine. The exchange flows without forcing, and that's rare. Treasure it.",
                    amizadeDuvidosa: "It's hard to know if someone is a true friend just from messages. Friendship is proven over time and actions, not words.",
                    // FAMILY
                    familiaDistante: "Family distance can hurt, but it's often about boundaries, not rejection. Give space without resentment.",
                    familiaDesigual: "Family dynamics are complex. Different effort levels are common ‚Äî it's not always about love.",
                    familiaSaudavel: "This family connection seems balanced. Healthy family bonds are built on respect, not obligation.",
                    familiaDificil: "Family relationships carry history. One conversation doesn't show the full picture.",
                    // WORK
                    trabalhoProfissional: "This seems like professional communication. Keep boundaries clear ‚Äî work relationships aren't personal.",
                    trabalhoDesigual: "Power dynamics at work are normal. Don't confuse professional distance with personal rejection.",
                    trabalhoSaudavel: "Professional relationship with good boundaries. Keep it that way.",
                    trabalhoComplicado: "Work relationships can be tricky. Maintain professionalism and don't over-invest emotionally."
                },
                padrao: {
                    evasaoAlta: "Recurring vague phrases: 'let's see', 'I don't know', 'when possible'. Each one is an exit door kept open.",
                    assimetriaAlta: "The effort always comes from the same side. Initiative, travel, availability ‚Äî all yours.",
                    faltaClarezaAlta: "Requests for clarity are met with more ambiguity. This is circular and intentional.",
                    baixaReciprocidadeAlta: "Passive availability: 'if you want', 'when you can'. Those who want, act. Those who don't, wait.",
                    desvioSexualHumorAlto: "Attempts to deepen are followed by jokes, sexualization, or topic changes. The emotional deflection is systematic.",
                    vulnerabilidadeSemAcaoAlta: "Apologies, promises to change, declarations of love ‚Äî but behavior stays the same. Performative vulnerability.",
                    evasaoEleganteAlta: "'Let it flow', 'let's not label it', 'everyone at their own pace'. Avoidance disguised as emotional maturity.",
                    misto: "Sweet words without corresponding action. Verbal affection that never becomes real commitment.",
                    saudavel: "Communication flows well. There's reciprocity and mutual respect in the exchange.",
                    // FRIENDSHIP
                    amizadeDistante: "Shorter responses, less initiative, less availability. Could just be a life phase.",
                    amizadeDesigual: "You seem to invest more time and energy. Could be different styles, not necessarily lack of care.",
                    amizadeSaudavel: "Humor, lightness, reciprocity. You understand each other without much explaining.",
                    amizadeDuvidosa: "Friendship is built with consistency. One conversation doesn't show the whole picture.",
                    // FAMILY
                    familiaDistante: "Less contact, pragmatic responses. Could be emotional protection, not necessarily lack of love.",
                    familiaDesigual: "Family doesn't always show affection the same way. Different generations, different languages.",
                    familiaSaudavel: "Mutual respect despite differences. That's family maturity.",
                    familiaDificil: "Family patterns are hard to change. Look at the bigger context, not just one conversation.",
                    // WORK
                    trabalhoProfissional: "Formal tone, objectivity. That's professionalism, not coldness.",
                    trabalhoDesigual: "Hierarchies create natural distance. Don't personalize what's structural.",
                    trabalhoSaudavel: "Clear and respectful communication. Good professional boundaries.",
                    trabalhoComplicado: "Mix of personal and professional. Careful with expectations outside work context."
                },
                risco: {
                    evasaoAlta: "You'll keep investing energy in something that doesn't evolve. Months will pass and nothing will change.",
                    assimetriaAlta: "You'll exhaust yourself maintaining something they don't sustain. Chronic imbalance destroys self-esteem.",
                    faltaClarezaAlta: "Emotional limbo will generate constant anxiety. You deserve clarity, not guessing.",
                    baixaReciprocidadeAlta: "You'll normalize receiving less than you give. This recalibrates your standards downward.",
                    desvioSexualHumorAlto: "You'll keep seeking emotional connection and being redirected to superficiality. Exhaustion guaranteed.",
                    vulnerabilidadeSemAcaoAlta: "You'll stay trapped in the 'this time will be different' cycle. Hope without evidence.",
                    evasaoEleganteAlta: "You'll accept indefinition as normal. The 'flow' is one-sided ‚Äî only benefits whoever avoids commitment.",
                    misto: "The more you try, the more they settle. The cycle only breaks when you stop.",
                    saudavel: "Balanced relationship. Keep cultivating this connection with presence and honesty.",
                    // FRIENDSHIP
                    amizadeDistante: "Forcing closeness may push further away. Let the friendship breathe.",
                    amizadeDesigual: "Friendships go through phases. Don't draw definitive conclusions from one moment.",
                    amizadeSaudavel: "No risk identified. Light friendships are valuable ‚Äî don't complicate.",
                    amizadeDuvidosa: "The risk is creating unrealistic expectations. Let time show who this person is.",
                    // FAMILY
                    familiaDistante: "Forcing connection may create more resistance. Respect their time.",
                    familiaDesigual: "Demanding reciprocity from family may create more conflict. Accept limitations.",
                    familiaSaudavel: "No risk identified. Healthy family bonds are rare ‚Äî treasure them.",
                    familiaDificil: "The risk is repeating old patterns. Break the cycle with healthy boundaries.",
                    // WORK
                    trabalhoProfissional: "No risk identified. Keep the relationship in professional context.",
                    trabalhoDesigual: "The risk is taking personally what's structural. Keep perspective.",
                    trabalhoSaudavel: "No risk. Keep maintaining clear boundaries.",
                    trabalhoComplicado: "The risk is mixing personal expectations with professional ones. Set boundaries."
                },
                movimento: {
                    evasaoAlta: "Ask ONE direct question: 'Do you want to build something with me, yes or no?' Accept the answer ‚Äî including silence.",
                    assimetriaAlta: "Stop initiating for 2 weeks. Observe who sustains the relationship when you step back. The answer will be clear.",
                    faltaClarezaAlta: "Verbalize: 'I need clarity to continue.' Set an internal deadline. Don't give more chances without concrete action.",
                    baixaReciprocidadeAlta: "Reduce availability. Those who feel your absence will seek you. Those who don't already gave you the answer.",
                    desvioSexualHumorAlto: "Next time they deflect: 'I'd rather resolve what's pending before continuing in this tone.' Don't accept the topic change.",
                    vulnerabilidadeSemAcaoAlta: "Stop listening to promises. Say: 'I don't need words, I need change. Show me with actions.' Set internal deadline.",
                    evasaoEleganteAlta: "Confront the disguised avoidance: 'Flow to where? I need to know if this has a future or if I'm wasting time.'",
                    misto: "One final direct attempt. If the answer is vague, end with respect. You've done your part.",
                    saudavel: "Enjoy what's working. Good relationships deserve to be nurtured, not over-analyzed.",
                    // FRIENDSHIP
                    amizadeDistante: "Give space. If the friendship is real, it returns naturally. If not, you have your answer.",
                    amizadeDesigual: "Stop reaching out for a while. See if they come to you. True friendship doesn't need constant effort.",
                    amizadeSaudavel: "Keep being present. Good friendships are rare ‚Äî treasure this one.",
                    amizadeDuvidosa: "Watch actions over time, not just words. True friendship is proven in hard moments.",
                    // FAMILY
                    familiaDistante: "Keep the door open without forcing. Family has its own timing.",
                    familiaDesigual: "Accept that not everyone expresses love the same way. Focus on what's within your reach.",
                    familiaSaudavel: "Keep nurturing this connection. Healthy family is the foundation of everything.",
                    familiaDificil: "Protect your peace. You can love from a distance if necessary.",
                    // WORK
                    trabalhoProfissional: "Stay professional. Don't mix personal expectations.",
                    trabalhoDesigual: "Focus on your work, not power dynamics. Deliver results.",
                    trabalhoSaudavel: "Keep it up. Good work relationships make everything easier.",
                    trabalhoComplicado: "Set clear boundaries. Work is work, personal is personal."
                }
            }
        };

        // CONDITIONAL RESPONSES based on pattern
        const respostasCondicionais = {
            pt: {
                evasaoAlta: [
                    { tipo: 'For√ßar posi√ß√£o', texto: 'Preciso de uma resposta clara: voc√™ quer construir algo comigo ou n√£o?' },
                    { tipo: 'Encerrar com dignidade', texto: 'Entendi. Vou interpretar a falta de clareza como resposta. Tudo de bom.' },
                    { tipo: 'Definir prazo', texto: 'Vou te dar uma semana pra pensar. Se n√£o tiver resposta, sigo em frente.' }
                ],
                assimetriaAlta: [
                    { tipo: 'Retirada estrat√©gica', texto: '[N√£o responder. Observe se a pessoa busca voc√™ quando voc√™ para de ir atr√°s.]' },
                    { tipo: 'Pedir reciprocidade', texto: 'Dessa vez, voc√™ vem at√© mim. Quero ver o quanto voc√™ quer estar aqui.' },
                    { tipo: 'Confronto direto', texto: 'Percebi que sempre sou eu quem corre atr√°s. Isso n√£o funciona pra mim.' }
                ],
                faltaClarezaAlta: [
                    { tipo: 'Exigir defini√ß√£o', texto: 'Preciso saber o que somos. Se n√£o der pra definir, n√£o d√° pra continuar.' },
                    { tipo: '√öltima chance', texto: 'Vou perguntar uma √∫ltima vez: o que voc√™ quer comigo?' },
                    { tipo: 'Encerrar o limbo', texto: 'N√£o consigo mais ficar nesse entre. Ou avan√ßa ou eu saio.' }
                ],
                baixaReciprocidadeAlta: [
                    { tipo: 'Teste de interesse', texto: '[Ficar em sil√™ncio por 3-5 dias. Se n√£o vier atr√°s, voc√™ tem a resposta.]' },
                    { tipo: 'Pedir a√ß√£o concreta', texto: 'Quero que voc√™ planeje algo pra gente. Quero ver voc√™ se movendo.' },
                    { tipo: 'Verbalizar o desequil√≠brio', texto: 'Sinto que dou mais do que recebo. Isso precisa mudar.' }
                ],
                misto: [
                    { tipo: 'Confronto final', texto: 'Voc√™ quer estar comigo ou n√£o? Preciso de uma resposta, n√£o de mais palavras.' },
                    { tipo: 'Retirada com dignidade', texto: 'Vou recuar. Se sentir minha falta, voc√™ sabe onde me encontrar.' },
                    { tipo: 'Encerrar o ciclo', texto: 'Cansei de correr atr√°s de algo que n√£o se move. Vou seguir.' }
                ],
                desvioSexualHumorAlto: [
                    { tipo: 'Dessexualizar', texto: 'Prefiro resolver o que est√° pendente antes de continuar nesse tom.' },
                    { tipo: 'Confrontar o desvio', texto: 'Toda vez que tento conversar s√©rio, voc√™ desvia. Isso n√£o funciona mais pra mim.' },
                    { tipo: 'Exigir profundidade', texto: 'Preciso de conex√£o emocional, n√£o s√≥ f√≠sica. Se isso n√£o √© poss√≠vel, preciso saber.' }
                ],
                vulnerabilidadeSemAcaoAlta: [
                    { tipo: 'Exigir a√ß√£o', texto: 'N√£o preciso de promessas. Preciso de mudan√ßa. Me mostra com a√ß√£o.' },
                    { tipo: 'Estabelecer prazo', texto: 'Vou observar as pr√≥ximas semanas. Palavras n√£o valem mais nada ‚Äî s√≥ comportamento.' },
                    { tipo: 'Confronto direto', texto: 'Voc√™ j√° disse isso antes. O que vai ser diferente dessa vez? Me mostra, n√£o me conta.' }
                ],
                evasaoEleganteAlta: [
                    { tipo: 'Confrontar a evas√£o', texto: 'Fluir pra onde? Preciso saber se isso tem futuro ou se estou perdendo tempo.' },
                    { tipo: 'For√ßar defini√ß√£o', texto: '"Deixar rolar" funciona pra voc√™, n√£o pra mim. Preciso de clareza.' },
                    { tipo: 'Definir prazo', texto: 'N√£o vou mais aceitar indefini√ß√£o. Me diz o que voc√™ quer at√© [data]. Se n√£o souber, eu decido por n√≥s dois.' }
                ],
                saudavel: [
                    { tipo: 'Celebrar a conex√£o', texto: 'Gosto muito de ter voc√™ por perto. Essa troca me faz bem.' },
                    { tipo: 'Nutrir a rela√ß√£o', texto: 'Que bom que a gente consegue conversar assim. Vamos manter isso.' }
                ],
                // AMIZADE
                amizadeDistante: [
                    { tipo: 'Dar espa√ßo', texto: 'Sinto que voc√™ t√° num momento diferente. T√¥ aqui se precisar.' },
                    { tipo: 'Check-in leve', texto: 'Sumiu! Tudo bem por a√≠? Sem cobran√ßa, s√≥ queria saber de voc√™.' }
                ],
                amizadeDesigual: [
                    { tipo: 'Observar', texto: '[N√£o puxe conversa por uns dias. Veja se ela vem at√© voc√™.]' },
                    { tipo: 'Ser honesta', texto: 'Sinto que ando puxando mais a amizade. T√° tudo bem com a gente?' }
                ],
                amizadeSaudavel: [
                    { tipo: 'Valorizar', texto: 'Gosto muito da nossa amizade. Obrigada por existir.' },
                    { tipo: 'Manter presente', texto: 'Bora marcar algo? Faz tempo que n√£o nos vemos.' }
                ],
                amizadeDuvidosa: [
                    { tipo: 'Observar a√ß√µes', texto: '[Observe como ela age nos pr√≥ximos encontros. Amizade se prova com consist√™ncia.]' },
                    { tipo: 'Ser direta', texto: '√Äs vezes fico na d√∫vida sobre nossa amizade. Posso ser honesta com voc√™?' }
                ],
                // FAM√çLIA
                familiaDistante: [
                    { tipo: 'Manter porta aberta', texto: 'Sei que a gente n√£o conversa muito, mas t√¥ aqui se precisar.' },
                    { tipo: 'Respeitar limites', texto: '[D√™ espa√ßo. Fam√≠lia tem seu pr√≥prio tempo.]' }
                ],
                familiaDesigual: [
                    { tipo: 'Aceitar diferen√ßas', texto: '[Nem todos expressam amor igual. Observe as a√ß√µes, n√£o s√≥ palavras.]' },
                    { tipo: 'Focar no poss√≠vel', texto: 'Gostaria que a gente conversasse mais, mas respeito seu tempo.' }
                ],
                familiaSaudavel: [
                    { tipo: 'Valorizar', texto: 'Gosto muito de ter voc√™ na minha vida. Obrigada por tudo.' },
                    { tipo: 'Fortalecer', texto: 'Que bom que a gente se entende. Quero manter isso.' }
                ],
                familiaDificil: [
                    { tipo: 'Proteger-se', texto: '[Mantenha dist√¢ncia saud√°vel se necess√°rio. Voc√™ pode amar de longe.]' },
                    { tipo: 'Ser clara', texto: 'Preciso de respeito pra continuar essa rela√ß√£o.' }
                ],
                // TRABALHO
                trabalhoProfissional: [
                    { tipo: 'Manter limites', texto: '[Mantenha a rela√ß√£o no contexto profissional.]' },
                    { tipo: 'Ser objetiva', texto: 'Vamos focar no que precisamos resolver.' }
                ],
                trabalhoDesigual: [
                    { tipo: 'N√£o personalizar', texto: '[Din√¢micas de poder s√£o normais. N√£o leve para o pessoal.]' },
                    { tipo: 'Focar em resultados', texto: 'Vou me concentrar em entregar bons resultados.' }
                ],
                trabalhoSaudavel: [
                    { tipo: 'Manter profissionalismo', texto: 'Obrigada pela parceria. Trabalhar com voc√™ facilita muito.' },
                    { tipo: 'Valorizar', texto: 'Gosto de como a gente trabalha junto. Vamos manter assim.' }
                ],
                trabalhoComplicado: [
                    { tipo: 'Estabelecer limites', texto: 'Prefiro manter nossa rela√ß√£o no contexto de trabalho.' },
                    { tipo: 'Ser clara', texto: '[Defina limites claros entre pessoal e profissional.]' }
                ]
            },
            en: {
                evasaoAlta: [
                    { tipo: 'Force position', texto: 'I need a clear answer: do you want to build something with me or not?' },
                    { tipo: 'Exit with dignity', texto: 'I understand. I\'ll interpret the lack of clarity as an answer. All the best.' },
                    { tipo: 'Set deadline', texto: 'I\'ll give you a week to think. If there\'s no answer, I\'m moving on.' }
                ],
                assimetriaAlta: [
                    { tipo: 'Strategic withdrawal', texto: '[Don\'t respond. Observe if they reach out when you stop chasing.]' },
                    { tipo: 'Ask for reciprocity', texto: 'This time, you come to me. I want to see how much you want to be here.' },
                    { tipo: 'Direct confrontation', texto: 'I noticed I\'m always the one chasing. This doesn\'t work for me.' }
                ],
                faltaClarezaAlta: [
                    { tipo: 'Demand definition', texto: 'I need to know what we are. If we can\'t define it, we can\'t continue.' },
                    { tipo: 'Last chance', texto: 'I\'m asking one last time: what do you want with me?' },
                    { tipo: 'End the limbo', texto: 'I can\'t stay in this in-between anymore. Either we move forward or I\'m out.' }
                ],
                baixaReciprocidadeAlta: [
                    { tipo: 'Interest test', texto: '[Stay silent for 3-5 days. If they don\'t reach out, you have your answer.]' },
                    { tipo: 'Ask for action', texto: 'I want you to plan something for us. I want to see you making an effort.' },
                    { tipo: 'Verbalize imbalance', texto: 'I feel like I give more than I receive. This needs to change.' }
                ],
                misto: [
                    { tipo: 'Final confrontation', texto: 'Do you want to be with me or not? I need an answer, not more words.' },
                    { tipo: 'Dignified withdrawal', texto: 'I\'m stepping back. If you miss me, you know where to find me.' },
                    { tipo: 'End the cycle', texto: 'I\'m tired of chasing something that doesn\'t move. I\'m moving on.' }
                ],
                desvioSexualHumorAlto: [
                    { tipo: 'Desexualize', texto: 'I\'d rather resolve what\'s pending before continuing in this tone.' },
                    { tipo: 'Confront deflection', texto: 'Every time I try to have a serious conversation, you deflect. This doesn\'t work for me anymore.' },
                    { tipo: 'Demand depth', texto: 'I need emotional connection, not just physical. If that\'s not possible, I need to know.' }
                ],
                vulnerabilidadeSemAcaoAlta: [
                    { tipo: 'Demand action', texto: 'I don\'t need promises. I need change. Show me with actions.' },
                    { tipo: 'Set deadline', texto: 'I\'ll be watching the next few weeks. Words mean nothing now ‚Äî only behavior counts.' },
                    { tipo: 'Direct confrontation', texto: 'You\'ve said this before. What will be different this time? Show me, don\'t tell me.' }
                ],
                evasaoEleganteAlta: [
                    { tipo: 'Confront avoidance', texto: 'Flow to where? I need to know if this has a future or if I\'m wasting my time.' },
                    { tipo: 'Force definition', texto: '"Going with the flow" works for you, not for me. I need clarity.' },
                    { tipo: 'Set deadline', texto: 'I won\'t accept indefinition anymore. Tell me what you want by [date]. If you don\'t know, I\'ll decide for both of us.' }
                ],
                saudavel: [
                    { tipo: 'Celebrate connection', texto: 'I really appreciate having you in my life. This bond is good for me.' },
                    { tipo: 'Nurture relationship', texto: 'I\'m glad we can talk like this. Let\'s keep nurturing this.' }
                ],
                // FRIENDSHIP
                amizadeDistante: [
                    { tipo: 'Give space', texto: 'I feel like you\'re in a different place right now. I\'m here if you need me.' },
                    { tipo: 'Light check-in', texto: 'Hey! Everything okay? No pressure, just wanted to check on you.' }
                ],
                amizadeDesigual: [
                    { tipo: 'Observe', texto: '[Don\'t reach out for a few days. See if they come to you.]' },
                    { tipo: 'Be honest', texto: 'I feel like I\'ve been carrying the friendship more. Is everything okay with us?' }
                ],
                amizadeSaudavel: [
                    { tipo: 'Appreciate', texto: 'I really value our friendship. Thanks for being you.' },
                    { tipo: 'Stay present', texto: 'Let\'s hang out soon? It\'s been a while.' }
                ],
                amizadeDuvidosa: [
                    { tipo: 'Watch actions', texto: '[Observe how they act in the next few encounters. Friendship is proven through consistency.]' },
                    { tipo: 'Be direct', texto: 'Sometimes I wonder about our friendship. Can I be honest with you?' }
                ],
                // FAMILY
                familiaDistante: [
                    { tipo: 'Keep door open', texto: 'I know we don\'t talk much, but I\'m here if you need me.' },
                    { tipo: 'Respect boundaries', texto: '[Give space. Family has its own timing.]' }
                ],
                familiaDesigual: [
                    { tipo: 'Accept differences', texto: '[Not everyone expresses love the same way. Watch actions, not just words.]' },
                    { tipo: 'Focus on possible', texto: 'I\'d like us to talk more, but I respect your space.' }
                ],
                familiaSaudavel: [
                    { tipo: 'Appreciate', texto: 'I\'m grateful to have you in my life. Thank you for everything.' },
                    { tipo: 'Strengthen', texto: 'I\'m glad we understand each other. I want to keep it this way.' }
                ],
                familiaDificil: [
                    { tipo: 'Protect yourself', texto: '[Maintain healthy distance if needed. You can love from afar.]' },
                    { tipo: 'Be clear', texto: 'I need respect to continue this relationship.' }
                ],
                // WORK
                trabalhoProfissional: [
                    { tipo: 'Maintain boundaries', texto: '[Keep the relationship in professional context.]' },
                    { tipo: 'Be objective', texto: 'Let\'s focus on what we need to solve.' }
                ],
                trabalhoDesigual: [
                    { tipo: 'Don\'t personalize', texto: '[Power dynamics are normal. Don\'t take it personally.]' },
                    { tipo: 'Focus on results', texto: 'I\'ll focus on delivering good results.' }
                ],
                trabalhoSaudavel: [
                    { tipo: 'Stay professional', texto: 'Thanks for the partnership. Working with you makes things easier.' },
                    { tipo: 'Appreciate', texto: 'I like how we work together. Let\'s keep it this way.' }
                ],
                trabalhoComplicado: [
                    { tipo: 'Set boundaries', texto: 'I prefer to keep our relationship in the work context.' },
                    { tipo: 'Be clear', texto: '[Set clear boundaries between personal and professional.]' }
                ]
            }
        };

        // Abuse screening content
        const triagemAbuso = {
            pt: {
                sinais: {
                    // Sinais GRAVES
                    ameacas: 'amea√ßas diretas ou veladas',
                    humilhacao: 'humilha√ß√£o expl√≠cita',
                    isolamento: 'tentativas de isolamento social',
                    controle_severo: 'controle severo sobre suas a√ß√µes',
                    // Sinais MODERADOS (desgaste/invalida√ß√£o)
                    gaslighting: 'questionamento da sua percep√ß√£o',
                    coercao: 'press√£o emocional',
                    invalidacao: 'invalida√ß√£o dos seus sentimentos',
                    controle_leve: 'monitoramento de contatos'
                },
                orientacao: {
                    baixo: 'Esses sinais isolados indicam desgaste emocional, n√£o necessariamente abuso. Mantenha aten√ß√£o e converse com algu√©m de confian√ßa se o padr√£o persistir.',
                    medio: 'H√° um padr√£o de invalida√ß√£o e desgaste emocional. Isso n√£o √© necessariamente abuso grave, mas merece aten√ß√£o. Considere conversar com algu√©m de confian√ßa ou profissional.',
                    alto: 'H√° sinais s√©rios de risco. Priorize sua seguran√ßa. N√ÉO confronte diretamente. Busque rede de apoio e ajuda profissional. CVV: 188 | Ligue 180 (viol√™ncia contra mulher)'
                }
            },
            en: {
                sinais: {
                    // GRAVE signals
                    ameacas: 'direct or veiled threats',
                    humilhacao: 'explicit humiliation',
                    isolamento: 'attempts at social isolation',
                    controle_severo: 'severe control over your actions',
                    // MODERATE signals (emotional wear/invalidation)
                    gaslighting: 'questioning your perception',
                    coercao: 'emotional pressure',
                    invalidacao: 'invalidation of your feelings',
                    controle_leve: 'contact monitoring'
                },
                orientacao: {
                    baixo: 'These isolated signs indicate emotional wear, not necessarily abuse. Stay alert and talk to someone you trust if the pattern persists.',
                    medio: 'There is a pattern of invalidation and emotional wear. This is not necessarily severe abuse, but deserves attention. Consider talking to someone you trust or a professional.',
                    alto: 'There are serious risk signs. Prioritize your safety. Do NOT confront directly. Seek support network and professional help.'
                }
            }
        };

        function setLang(lang) {
            currentLang = lang;
            const t = i18n[lang];
            if (!t) return; // Prote√ß√£o: idioma inv√°lido

            // Tradu√ß√µes via data-attributes (seguro - forEach ignora se vazio)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });

            // Tradu√ß√µes por ID - TODAS com prote√ß√£o defensiva
            const subtitle = document.getElementById('subtitle');
            if (subtitle && t.subtitle) subtitle.textContent = t.subtitle;

            const inputLabel = document.getElementById('inputLabel');
            if (inputLabel && t.inputLabel) inputLabel.textContent = t.inputLabel;

            const conversation = document.getElementById('conversation');
            if (conversation && t.placeholder) conversation.placeholder = t.placeholder;

            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn && t.analyzeBtn) analyzeBtn.textContent = t.analyzeBtn;

            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn && t.resetBtn) resetBtn.textContent = t.resetBtn;

            const protecaoTexto = document.getElementById('protecaoTexto');
            if (protecaoTexto && t.protecao) protecaoTexto.textContent = t.protecao;

            const fraseAncora = document.getElementById('fraseAncora');
            if (fraseAncora && t.fraseAncora) fraseAncora.textContent = t.fraseAncora;

            // Bot√µes copy e lang (seguros - forEach ignora se vazio)
            document.querySelectorAll('.copy-btn').forEach(btn => {
                if (!btn.classList.contains('copied') && t.copyBtn) btn.textContent = t.copyBtn;
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === lang.toUpperCase());
            });

            localStorage.setItem('alpha-lang', lang);
        }

        function setInputMode(mode) {
            inputMode = mode;
            const textModeBtn = document.getElementById('textModeBtn');
            const imageModeBtn = document.getElementById('imageModeBtn');
            const textInputWrapper = document.getElementById('textInputWrapper');
            const uploadArea = document.getElementById('uploadArea');

            if (textModeBtn) textModeBtn.classList.toggle('active', mode === 'text');
            if (imageModeBtn) imageModeBtn.classList.toggle('active', mode === 'image');
            if (textInputWrapper) textInputWrapper.classList.toggle('hidden', mode !== 'text');
            if (uploadArea) uploadArea.classList.toggle('active', mode === 'image');
        }

        // Context option selection
        document.querySelectorAll('.context-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.closest('.context-options');
                const contextType = parent.getAttribute('data-context');
                parent.querySelectorAll('.context-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                contextValues[contextType] = this.getAttribute('data-value');
            });
        });

        // Image upload handling
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const uploadPreview = document.getElementById('uploadPreview');

        uploadArea.addEventListener('click', (e) => {
            if (e.target === uploadArea || e.target.classList.contains('upload-icon') ||
                e.target.classList.contains('upload-text') || e.target.classList.contains('upload-hint')) {
                imageInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        imageInput.addEventListener('change', (e) => { handleFiles(e.target.files); });

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            const toAdd = newFiles.slice(0, 10 - uploadedImages.length);
            toAdd.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => { uploadedImages.push({ file, dataUrl: e.target.result }); renderPreview(); };
                reader.readAsDataURL(file);
            });
        }

        function renderPreview() {
            uploadPreview.innerHTML = uploadedImages.map((img, i) => `
                <div class="img-wrapper">
                    <img src="${img.dataUrl}" alt="Print ${i + 1}">
                    <button class="remove-img" onclick="removeImage(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeImage(index) { uploadedImages.splice(index, 1); renderPreview(); }

        function calculateScore(text, patternList) {
            const textLower = text.toLowerCase();
            let matches = 0;
            for (const pattern of patternList) {
                const regex = new RegExp(pattern.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                matches += (textLower.match(regex) || []).length;
            }
            return Math.min(100, Math.round(matches * 12));
        }

        function detectAbuseSignals(text, lang) {
            const textLower = text.toLowerCase();
            const detected = [];
            const abusePatterns = patterns.abuso[lang];

            let matchCount = 0;
            for (const pattern of abusePatterns) {
                if (textLower.includes(pattern.toLowerCase())) {
                    matchCount++;
                }
            }

            // SINAIS GRAVES: requerem ac√∫mulo para RISCO ALTO
            // - amea√ßas diretas, humilha√ß√£o expl√≠cita, isolamento, controle severo
            const sinaisGraves = {
                ameacas: ['cuidado comigo', 'te bater', 'vou te machucar', 'vou te matar', "i will hurt", 'be careful with me', 'hit you', "i'll hurt", "i'll kill"],
                humilhacao: ['voc√™ √© burra', 'voc√™ √© feia', 'voc√™ √© nojenta', 'tenho vergonha de voc√™', 'voc√™ me d√° nojo', "you're stupid", "you're ugly", "you're disgusting", "i'm ashamed of you", 'you disgust me'],
                isolamento: ['ningu√©m vai te querer', 'sem mim voc√™ n√£o √© nada', 'sua fam√≠lia n√£o te ama', 'no one will want you', "without me you're nothing", "your family doesn't love you"],
                controle_severo: ['n√£o pode sair', 'me mostra o celular', 'voc√™ n√£o pode ver', 'vou te trancar', "you can't go out", 'show me your phone', "you can't see", "i'll lock you"]
            };

            // SINAIS MODERADOS: desgaste emocional, invalida√ß√£o (n√£o justifica CVV/180)
            const sinaisModerados = {
                gaslighting: ['voc√™ √© louca', 't√° maluca', 'voc√™ entendeu errado', 'isso n√£o aconteceu', 'voc√™ t√° inventando', "you're crazy", 'you misunderstood', "that didn't happen", "you're making it up"],
                coercao: ['voc√™ me fez fazer', 'olha o que voc√™ me faz', 'por sua culpa', 'you made me do', 'look what you make me', "it's your fault"],
                invalidacao: ['que drama', 'exagerada', 'neur√≥tica', 'ciumenta', 'voc√™ viaja', 'n√£o √© pra tanto', 'so dramatic', 'exaggerating', 'neurotic', 'jealous', "it's not a big deal"],
                controle_leve: ['com quem voc√™ estava', 'n√£o fala com', 'who were you with', "don't talk to"]
            };

            let gravesDetectados = [];
            let moderadosDetectados = [];

            // Detecta sinais GRAVES
            for (const [category, phrases] of Object.entries(sinaisGraves)) {
                for (const phrase of phrases) {
                    if (textLower.includes(phrase.toLowerCase())) {
                        if (!gravesDetectados.includes(category)) gravesDetectados.push(category);
                        if (!detected.includes(category)) detected.push(category);
                    }
                }
            }

            // Detecta sinais MODERADOS
            for (const [category, phrases] of Object.entries(sinaisModerados)) {
                for (const phrase of phrases) {
                    if (textLower.includes(phrase.toLowerCase())) {
                        if (!moderadosDetectados.includes(category)) moderadosDetectados.push(category);
                        if (!detected.includes(category)) detected.push(category);
                    }
                }
            }

            return {
                detected,
                matchCount,
                graves: gravesDetectados,
                moderados: moderadosDetectados
            };
        }

        function inferFromContext() {
            let bonus = { evasao: 0, assimetria: 0, faltaClareza: 0, baixaReciprocidade: 0 };

            // INICIATIVA - quem puxa mais a rela√ß√£o
            if (contextValues.initiative === 'eu') {
                bonus.assimetria += 35;
                bonus.baixaReciprocidade += 25;
            } else if (contextValues.initiative === 'equilibrado') {
                bonus.assimetria -= 15;
                bonus.baixaReciprocidade -= 15;
            } else if (contextValues.initiative === 'outra') {
                bonus.assimetria -= 10;
            } else if (contextValues.initiative === 'dificil') {
                bonus.faltaClareza += 10;
            }

            // FREQU√äNCIA
            if (contextValues.frequency === 'nunca') {
                bonus.evasao += 30;
                bonus.baixaReciprocidade += 30;
                bonus.faltaClareza += 20;
            } else if (contextValues.frequency === 'raramente') {
                bonus.baixaReciprocidade += 25;
                bonus.evasao += 20;
            } else if (contextValues.frequency === 'mensal') {
                bonus.baixaReciprocidade += 15;
                bonus.evasao += 10;
            } else if (contextValues.frequency === 'semanal') {
                bonus.evasao -= 10;
                bonus.baixaReciprocidade -= 10;
            } else if (contextValues.frequency === 'diaria') {
                bonus.evasao -= 20;
                bonus.baixaReciprocidade -= 20;
            } else if (contextValues.frequency === 'varias') {
                bonus.evasao -= 15;
                bonus.baixaReciprocidade -= 15;
            }

            // TIPO DE V√çNCULO
            if (contextValues.relationType === 'indefinido' || contextValues.relationType === 'outro') {
                bonus.faltaClareza += 30;
                bonus.evasao += 20;
            }

            // ESTADO EMOCIONAL
            if (contextValues.emotional === 'confusa' || contextValues.emotional === 'ansiosa') {
                bonus.faltaClareza += 10;
            } else if (contextValues.emotional === 'cansada') {
                bonus.assimetria += 10;
            } else if (contextValues.emotional === 'tranquila') {
                bonus.faltaClareza -= 10;
            } else if (contextValues.emotional === 'indiferente') {
                bonus.baixaReciprocidade += 5;
            }

            Object.keys(bonus).forEach(key => {
                bonus[key] = Math.max(-30, bonus[key]);
            });

            return bonus;
        }

        // OVERRIDE CR√çTICO: Detecta sequ√™ncia aprofundamento ‚Üí desvio (Caso C)
        function detectDesvioSequencia(text, lang) {
            const textLower = text.toLowerCase();

            // Padr√µes de tentativa de aprofundamento emocional
            const aprofundamento = {
                pt: [
                    'quero conversar', 'preciso falar', 'o que voc√™ sente', 'o que a gente √©',
                    'onde isso vai', 'quero entender', 'preciso saber', 't√¥ confusa',
                    'me sinto', 'isso me machuca', 't√¥ triste', 'n√£o sei mais',
                    'a gente precisa', 'quero falar s√©rio', 'podemos conversar',
                    'quero que voc√™', 'preciso de voc√™', 'sinto que', 'parece que voc√™',
                    'me preocupo', 'tenho medo de', 'n√£o aguento mais', 'cansei de'
                ],
                en: [
                    'want to talk', 'need to talk', 'what do you feel', 'what are we',
                    'where is this going', 'want to understand', 'need to know', "i'm confused",
                    'i feel', 'this hurts me', "i'm sad", "i don't know anymore",
                    'we need to', 'want to talk seriously', 'can we talk',
                    'i want you to', 'i need you', 'i feel like', 'it seems like you',
                    "i'm worried", "i'm afraid of", "i can't take it anymore", "i'm tired of"
                ]
            };

            // Padr√µes de desvio (piada, sexualiza√ß√£o, mudan√ßa de assunto)
            const desvio = {
                pt: [
                    'haha', 'kkk', 'rsrs', 'relaxa', 'calma', 'para', 'que isso',
                    'que drama', 'exagerada', 'vem c√°', 'vem aqui', 'saudade do seu',
                    'quero te pegar', 't√¥ com tes√£o', 'manda foto', 'manda nude',
                    'bora falar de', 'muda de assunto', 'esquece isso', 'deixa isso pra l√°',
                    'n√£o √© pra tanto', 'voc√™ viaja', 'deixa eu te', 'vem pro meu'
                ],
                en: [
                    'haha', 'lol', 'lmao', 'relax', 'chill', 'stop', 'calm down',
                    'so dramatic', 'exaggerating', 'come here', 'miss your',
                    'want you', "i'm horny", 'send pic', 'send nudes',
                    "let's talk about", 'change the subject', 'forget it', 'let it go',
                    "it's not that bad", "you're tripping", 'let me'
                ]
            };

            // Detecta se h√° padr√µes de aprofundamento E desvio no mesmo texto
            let hasAprofundamento = false;
            let hasDesvio = false;
            let aprofundamentoIndex = -1;
            let desvioIndex = -1;

            for (const pattern of aprofundamento[lang]) {
                const idx = textLower.indexOf(pattern.toLowerCase());
                if (idx !== -1) {
                    hasAprofundamento = true;
                    if (aprofundamentoIndex === -1 || idx < aprofundamentoIndex) {
                        aprofundamentoIndex = idx;
                    }
                }
            }

            for (const pattern of desvio[lang]) {
                const idx = textLower.indexOf(pattern.toLowerCase());
                if (idx !== -1) {
                    hasDesvio = true;
                    if (desvioIndex === -1 || idx > desvioIndex) {
                        desvioIndex = idx;
                    }
                }
            }

            // OVERRIDE: Se h√° tentativa de aprofundamento E desvio,
            // especialmente se desvio vem DEPOIS do aprofundamento
            // ‚ö†Ô∏è IMPORTANTE: N√ÉO ativar para AMIZADE - risadas s√£o normais entre amigos!
            const vinculoAmizade = contextValues.relationType === 'amizade' || contextValues.relationType === 'familia';

            if (vinculoAmizade) {
                // Para amizade/fam√≠lia, n√£o for√ßar padr√£o de desvio sexual/humor
                return { isOverride: false, reason: 'vinculo_nao_romantico' };
            }

            if (hasAprofundamento && hasDesvio) {
                // Se desvio aparece depois do aprofundamento = sequ√™ncia cr√≠tica
                if (desvioIndex > aprofundamentoIndex) {
                    return { isOverride: true, reason: 'sequencia_aprofundamento_desvio' };
                }
                // Mesmo se n√£o em sequ√™ncia, a presen√ßa de ambos indica padr√£o
                return { isOverride: true, reason: 'coexistencia_aprofundamento_desvio' };
            }

            return { isOverride: false, reason: null };
        }

        function renderConditionalResponses(padraoKey, lang) {
            const respostas = respostasCondicionais[lang][padraoKey] || respostasCondicionais[lang].saudavel;
            const container = document.getElementById('respostasContainer');
            const t = i18n[lang];

            container.innerHTML = respostas.map((r, i) => `
                <div class="resposta-card">
                    <div class="resposta-tipo">${r.tipo}</div>
                    <p class="resposta-texto">${r.texto}</p>
                    <button class="copy-btn" onclick="copyText('${r.texto.replace(/'/g, "\\'")}', this)">${t.copyBtn}</button>
                </div>
            `).join('');
        }

        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const t = i18n[currentLang];
                document.querySelectorAll('.copy-btn').forEach(b => { b.classList.remove('copied'); b.textContent = t.copyBtn; });
                btn.classList.add('copied');
                btn.textContent = t.copiedBtn;
                setTimeout(() => { btn.classList.remove('copied'); btn.textContent = t.copyBtn; }, 2000);
            });
        }

        function analyzeConversationCore() {
            console.log('analyzeConversationCore called');
            // Core analysis - validation done by startAnalysisFlow()
            const text = document.getElementById('conversation').value.trim();
            console.log('Text length:', text.length);
            const lang = currentLang;
            const contextBonus = inferFromContext();

            let evasaoScore = inputMode === 'text' ? calculateScore(text, patterns.evasao[lang]) : 0;
            let assimetriaScore = inputMode === 'text' ? calculateScore(text, patterns.assimetria[lang]) : 0;
            let faltaClarezaScore = inputMode === 'text' ? calculateScore(text, patterns.faltaClareza[lang]) : 0;
            let baixaReciprocidadeScore = inputMode === 'text' ? calculateScore(text, patterns.baixaReciprocidade[lang]) : 0;
            let desvioSexualHumorScore = inputMode === 'text' ? calculateScore(text, patterns.desvioSexualHumor[lang]) : 0;
            let vulnerabilidadeSemAcaoScore = inputMode === 'text' ? calculateScore(text, patterns.vulnerabilidadeSemAcao[lang]) : 0;
            let evasaoEleganteScore = inputMode === 'text' ? calculateScore(text, patterns.evasaoElegante[lang]) : 0;

            evasaoScore = Math.min(100, evasaoScore + contextBonus.evasao);
            assimetriaScore = Math.min(100, assimetriaScore + contextBonus.assimetria);
            faltaClarezaScore = Math.min(100, faltaClarezaScore + contextBonus.faltaClareza);
            baixaReciprocidadeScore = Math.min(100, baixaReciprocidadeScore + contextBonus.baixaReciprocidade);
            // Evas√£o elegante adiciona ao score de evas√£o geral tamb√©m
            evasaoScore = Math.min(100, evasaoScore + Math.floor(evasaoEleganteScore * 0.5));

            if (inputMode === 'image') {
                const hasContext = Object.values(contextValues).some(v => v !== null);
                if (hasContext) {
                    evasaoScore = Math.max(evasaoScore, 25);
                    if (contextValues.relationType === 'indefinido') faltaClarezaScore = Math.max(faltaClarezaScore, 50);
                    if (contextValues.initiative === 'eu') assimetriaScore = Math.max(assimetriaScore, 50);
                }
            }

            // Abuse screening
            const abuseResult = inputMode === 'text' ? detectAbuseSignals(text, lang) : { detected: [], matchCount: 0 };
            const triagemEl = document.getElementById('triagemRisco');

            if (abuseResult.detected.length > 0) {
                triagemEl.classList.add('active');

                // NOVA L√ìGICA DE THRESHOLD:
                // - ALTO: apenas com M√öLTIPLOS sinais GRAVES (2+) ou amea√ßa direta
                // - M√âDIO: sinais moderados ou 1 sinal grave (desgaste/invalida√ß√£o)
                // - BAIXO: poucos sinais detectados
                // REGRA: MVP √© 100% rom√¢ntico, ent√£o todos os v√≠nculos podem escalar para ALTO
                let nivel = 'baixo';
                let nivelClass = 'nivel-baixo';

                const numGraves = abuseResult.graves ? abuseResult.graves.length : 0;
                const numModerados = abuseResult.moderados ? abuseResult.moderados.length : 0;
                const temAmeaca = abuseResult.graves && abuseResult.graves.includes('ameacas');

                // MVP √© 100% rom√¢ntico (ficante, dates, indefinido, namoro)
                const vinculoAmoroso = true;

                // RISCO ALTO: s√≥ com ac√∫mulo de sinais GRAVES (MVP √© 100% rom√¢ntico)
                // (amea√ßa direta + outro sinal grave, ou 3+ sinais graves diferentes)
                if (vinculoAmoroso && temAmeaca && numGraves >= 2) {
                    nivel = 'alto'; nivelClass = 'nivel-alto';
                } else if (vinculoAmoroso && numGraves >= 3) {
                    nivel = 'alto'; nivelClass = 'nivel-alto';
                }
                // RISCO M√âDIO: 1 sinal grave OU m√∫ltiplos sinais moderados (independe do v√≠nculo)
                else if (numGraves >= 1 || numModerados >= 2) {
                    nivel = 'medio'; nivelClass = 'nivel-medio';
                }
                // RISCO BAIXO: sinais moderados isolados (desgaste, invalida√ß√£o leve)

                const nivelEl = document.getElementById('nivelRisco');
                nivelEl.className = 'nivel ' + nivelClass;
                nivelEl.textContent = t['nivel' + nivel.charAt(0).toUpperCase() + nivel.slice(1)];

                const sinaisTexto = abuseResult.detected.map(s => triagemAbuso[lang].sinais[s]).filter(s => s).join(', ');
                document.getElementById('sinaisDetectados').textContent = lang === 'pt'
                    ? 'A conversa cont√©m sinais de: ' + sinaisTexto
                    : 'The conversation contains signs of: ' + sinaisTexto;
                document.getElementById('orientacaoSegura').textContent = triagemAbuso[lang].orientacao[nivel];
            } else {
                triagemEl.classList.remove('active');
            }

            // Determine primary pattern - prioriza objetivo selecionado
            let padraoKey = 'saudavel';
            let maxScore = 25;

            // Aplica b√¥nus baseado no OBJETIVO selecionado (dropdown)
            const objetivo = contextValues.objective;
            if (objetivo === 'interesse') {
                evasaoScore = Math.min(100, evasaoScore + 15);
                faltaClarezaScore = Math.min(100, faltaClarezaScore + 10);
            } else if (objetivo === 'reciprocidade') {
                assimetriaScore = Math.min(100, assimetriaScore + 15);
                baixaReciprocidadeScore = Math.min(100, baixaReciprocidadeScore + 15);
            } else if (objetivo === 'evasao') {
                evasaoScore = Math.min(100, evasaoScore + 20);
            } else if (objetivo === 'insistir') {
                assimetriaScore = Math.min(100, assimetriaScore + 10);
                evasaoScore = Math.min(100, evasaoScore + 10);
            } else if (objetivo === 'redflags') {
                // Aumenta sensibilidade para todos os sinais de risco
                vulnerabilidadeSemAcaoScore = Math.min(100, vulnerabilidadeSemAcaoScore + 15);
                desvioSexualHumorScore = Math.min(100, desvioSexualHumorScore + 10);
            }

            // Se objetivo √© "outro", analisa texto livre (comportamento legado)
            if (objetivo === 'outro' && doubt) {
                const doubtLower = doubt.toLowerCase();
                if (/ele (gosta|quer|tem interesse)|t√° enrolando|evitando|fugindo|n√£o responde|some/i.test(doubtLower)) {
                    evasaoScore = Math.min(100, evasaoScore + 15);
                }
                if (/eu (que|sempre|puxo|corro)|s√≥ eu|eu (busco|inicio)|desigual/i.test(doubtLower)) {
                    assimetriaScore = Math.min(100, assimetriaScore + 15);
                }
                if (/o que somos|definir|namoro|relacionamento|futuro|clareza|compromisso/i.test(doubtLower)) {
                    faltaClarezaScore = Math.min(100, faltaClarezaScore + 15);
                }
            }

            // ‚ö†Ô∏è DATING APP HEURISTICS: se plataforma √© dating app + nunca se viram
            const isDatingApp = contextValues.platform === 'bumble' || contextValues.platform === 'tinder';
            const nuncaSeViram = contextValues.frequency === 'nunca';
            if (isDatingApp && nuncaSeViram) {
                // Reduz peso de baixa reciprocidade (normal em dating apps)
                baixaReciprocidadeScore = Math.max(0, baixaReciprocidadeScore - 20);
                // Aumenta foco em proposta concreta / follow-through
                evasaoScore = Math.min(100, evasaoScore + 10);
                faltaClarezaScore = Math.min(100, faltaClarezaScore + 10);
            }

            if (evasaoScore > maxScore) { padraoKey = 'evasaoAlta'; maxScore = evasaoScore; }
            if (assimetriaScore > maxScore) { padraoKey = 'assimetriaAlta'; maxScore = assimetriaScore; }
            if (faltaClarezaScore > maxScore) { padraoKey = 'faltaClarezaAlta'; maxScore = faltaClarezaScore; }
            if (baixaReciprocidadeScore > maxScore) { padraoKey = 'baixaReciprocidadeAlta'; maxScore = baixaReciprocidadeScore; }
            if (desvioSexualHumorScore > maxScore) { padraoKey = 'desvioSexualHumorAlto'; maxScore = desvioSexualHumorScore; }
            if (vulnerabilidadeSemAcaoScore > maxScore) { padraoKey = 'vulnerabilidadeSemAcaoAlta'; maxScore = vulnerabilidadeSemAcaoScore; }
            if (evasaoEleganteScore > maxScore) { padraoKey = 'evasaoEleganteAlta'; maxScore = evasaoEleganteScore; }

            // Misto: m√∫ltiplos padr√µes significativos
            const allScores = [evasaoScore, assimetriaScore, faltaClarezaScore, baixaReciprocidadeScore, desvioSexualHumorScore, vulnerabilidadeSemAcaoScore];
            if (allScores.filter(s => s > 35).length >= 2) padraoKey = 'misto';

            // ‚ö†Ô∏è L√ìGICA POR TIPO DE V√çNCULO - Usa diagn√≥sticos espec√≠ficos
            const tipoVinculo = contextValues.relationType;

            // Detecta perguntas sobre amizade (s√≥ se objetivo √© "outro" com texto)
            const doubtLower = doubt ? doubt.toLowerCase() : '';
            const perguntaAmizade = doubtLower && /amig[oa]|amizade|confia|verdadeir[oa]/i.test(doubtLower);

            // ‚ö†Ô∏è IMPORTANTE: Se detectou sinais de abuso, N√ÉO usar padr√µes pacificadores
            const temSinaisAbuso = abuseResult.detected.length > 0;

            // AMIZADE/FAM√çLIA: Threshold mais alto (50) + padr√µes espec√≠ficos
            // MAS: se tem sinais de abuso, N√ÉO pacificar - usar diagn√≥sticos normais
            if ((tipoVinculo === 'amizade' || tipoVinculo === 'familia' || perguntaAmizade) && !temSinaisAbuso) {
                const thresholdAlto = 50;
                const prefixo = tipoVinculo === 'familia' ? 'familia' : 'amizade';

                if (maxScore < thresholdAlto) {
                    padraoKey = prefixo + 'Saudavel';
                } else if (perguntaAmizade && maxScore < 60) {
                    padraoKey = prefixo + 'Duvidosa';
                } else if (assimetriaScore > thresholdAlto || baixaReciprocidadeScore > thresholdAlto) {
                    padraoKey = prefixo + 'Desigual';
                } else if (evasaoScore > thresholdAlto) {
                    padraoKey = prefixo === 'familia' ? 'familiaDistante' : 'amizadeDistante';
                } else if (tipoVinculo === 'familia' && maxScore >= 60) {
                    padraoKey = 'familiaDificil';
                } else {
                    padraoKey = prefixo + 'Duvidosa';
                }
            }

            // TRABALHO: Padr√µes profissionais (tamb√©m n√£o pacificar se tem sinais de abuso)
            else if (tipoVinculo === 'trabalho' && !temSinaisAbuso) {
                const thresholdAlto = 45;

                if (maxScore < thresholdAlto) {
                    padraoKey = 'trabalhoSaudavel';
                } else if (assimetriaScore > thresholdAlto) {
                    padraoKey = 'trabalhoDesigual';
                } else if (maxScore >= 60) {
                    padraoKey = 'trabalhoComplicado';
                } else {
                    padraoKey = 'trabalhoProfissional';
                }
            }

            // ‚ö†Ô∏è OVERRIDE CR√çTICO - Caso C: Desvio sexual/humor como anest√©sico
            // Se detectar sequ√™ncia aprofundamento ‚Üí desvio, FOR√áA padr√£o dominante
            // PRIORIDADE DE PADR√ÉO > SCORE (conforme instru√ß√£o do Fred)
            let casoCAtivado = false;
            if (inputMode === 'text') {
                const desvioOverride = detectDesvioSequencia(text, lang);
                if (desvioOverride.isOverride) {
                    // Override BIN√ÅRIO: for√ßa desvioSexualHumorAlto independente de outros scores
                    padraoKey = 'desvioSexualHumorAlto';
                    casoCAtivado = true;
                    // Log para debug
                    console.log('‚ö†Ô∏è CASO C Override ativado:', desvioOverride.reason);
                }
            }

            detectedPattern = padraoKey;

            // Se Caso C ativado, garantir que risco NUNCA seja "saudavel" ou "baixo"
            // For√ßa exibi√ß√£o de triagem com n√≠vel m√≠nimo M√âDIO
            if (casoCAtivado && !triagemEl.classList.contains('active')) {
                triagemEl.classList.add('active');
                const nivelEl = document.getElementById('nivelRisco');
                nivelEl.className = 'nivel nivel-medio';
                nivelEl.textContent = t.nivelMedio;
                document.getElementById('sinaisDetectados').textContent = lang === 'pt'
                    ? 'A conversa cont√©m sinais de: desvio emocional sistem√°tico (sexualiza√ß√£o/humor como anest√©sico)'
                    : 'The conversation contains signs of: systematic emotional deflection (sexualization/humor as numbing)';
                document.getElementById('orientacaoSegura').textContent = lang === 'pt'
                    ? 'Esse padr√£o sugere evita√ß√£o de profundidade emocional. N√£o determina inten√ß√£o, mas impede constru√ß√£o de v√≠nculo real.'
                    : 'This pattern suggests avoidance of emotional depth. Does not determine intent, but prevents building real connection.';
            }
            document.getElementById('feedbackPattern').value = padraoKey;
            document.getElementById('feedbackLang').value = lang;

            console.log('=== RENDER FINAL ===');
            console.log('padraoKey:', padraoKey);
            console.log('lang:', lang);

            const diag = diagnosticos[lang];
            console.log('diag object:', diag ? 'exists' : 'MISSING!');
            console.log('diag.central[padraoKey]:', diag?.central?.[padraoKey] || 'UNDEFINED!');

            // Prote√ß√£o: se padr√£o n√£o existir, usar fallback
            const centralText = diag?.central?.[padraoKey] || 'An√°lise conclu√≠da. Padr√£o detectado: ' + padraoKey;
            const padraoText = diag?.padrao?.[padraoKey] || 'Verifique o contexto da conversa.';
            const riscoText = diag?.risco?.[padraoKey] || 'Continue atenta aos sinais.';
            const movimentoText = diag?.movimento?.[padraoKey] || 'Reflita sobre a din√¢mica da rela√ß√£o.';

            document.getElementById('diagnosticoCentral').textContent = centralText;
            document.getElementById('padraoRecorrente').textContent = padraoText;
            document.getElementById('riscoReal').textContent = riscoText;
            document.getElementById('proximoMovimento').textContent = movimentoText;

            console.log('Texts set successfully');

            // Render conditional responses
            renderConditionalResponses(padraoKey, lang);

            // ‚úÖ ESCONDER FRASES NEGATIVAS QUANDO RELA√á√ÉO √â SAUD√ÅVEL
            const frasesNegativas = document.querySelector('.protecao-frases');
            const ehSaudavel = padraoKey === 'saudavel' || padraoKey.includes('Saudavel');
            if (ehSaudavel) {
                // Rela√ß√£o saud√°vel: esconder frases negativas, mostrar frase positiva
                if (frasesNegativas) frasesNegativas.style.display = 'none';
                // Mostrar mensagem positiva alternativa
                const fraseAncora = document.getElementById('fraseAncora');
                const fraseApoio = document.querySelector('.protecao:not(.frase-ancora)');
                if (fraseAncora) {
                    fraseAncora.textContent = lang === 'pt'
                        ? 'Rela√ß√µes saud√°veis se constroem com reciprocidade e clareza. Continue cultivando isso.'
                        : 'Healthy relationships are built with reciprocity and clarity. Keep cultivating this.';
                    fraseAncora.parentElement.style.display = 'block';
                }
                if (fraseApoio) fraseApoio.style.display = 'none';
            } else {
                // Rela√ß√£o com problemas: mostrar frases de apoio
                if (frasesNegativas) frasesNegativas.style.display = 'block';
            }

            console.log('=== FINAL RENDER ===');
            console.log('Hiding inputArea, showing results...');

            const inputAreaEl = document.getElementById('inputArea');
            const resultsEl = document.getElementById('results');

            console.log('inputArea element:', inputAreaEl ? 'found' : 'NOT FOUND!');
            console.log('results element:', resultsEl ? 'found' : 'NOT FOUND!');

            if (inputAreaEl) inputAreaEl.style.display = 'none';
            if (resultsEl) resultsEl.classList.add('active');

            console.log('‚úÖ ANALYSIS COMPLETE - Results should be visible now');
        }

        function selectThumb(btn) {
            document.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('feedbackHelpful').value = btn.getAttribute('data-value');
        }

        // Feedback form submission - UX melhorada
        document.getElementById('feedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Valida√ß√£o m√≠nima: s√≥ precisa de thumbs OU score
            const helpful = document.getElementById('feedbackHelpful').value;
            const accuracy = document.getElementById('feedbackAccuracy').value;

            // Se n√£o tem nem thumbs nem moveu o score, pede pelo menos um
            if (!helpful && accuracy === '5') {
                const t = i18n[currentLang];
                const msg = currentLang === 'pt'
                    ? 'Selecione üëç ou üëé, ou mova a escala de precis√£o.'
                    : 'Select üëç or üëé, or move the accuracy scale.';
                alert(msg);
                return;
            }

            const formData = new FormData(this);
            const submitBtn = this.querySelector('.feedback-submit');
            const originalText = submitBtn.textContent;

            // Feedback visual imediato
            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'pt' ? 'Enviando...' : 'Sending...';

            fetch('/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(formData).toString()
            }).then(() => {
                showFeedbackSuccess();
            }).catch(() => {
                // Mesmo com erro de rede, mostra sucesso (dados podem ter sido enviados)
                // Em produ√ß√£o com Netlify Forms, geralmente funciona
                showFeedbackSuccess();
            });

            function showFeedbackSuccess() {
                document.getElementById('feedbackForm').style.display = 'none';
                document.getElementById('feedbackSuccess').classList.add('active');

                // Reset do formul√°rio para pr√≥ximo uso
                document.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('feedbackHelpful').value = '';
                document.getElementById('feedbackAccuracy').value = '5';
                document.querySelectorAll('.feedback-textarea').forEach(ta => ta.value = '');
                document.querySelector('.feedback-input[type="email"]').value = '';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        function resetAnalysis() {
            document.getElementById('conversation').value = '';
            document.getElementById('inputArea').style.display = 'block';
            document.getElementById('results').classList.remove('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('triagemRisco').classList.remove('active');
            document.getElementById('feedbackForm').style.display = 'block';
            document.getElementById('feedbackSuccess').classList.remove('active');
            document.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('feedbackHelpful').value = '';
            document.getElementById('feedbackAccuracy').value = '5';
            uploadedImages = [];
            renderPreview();
            contextValues = { objective: null, relationType: null, platform: null, initiative: null, frequency: null, emotional: null };
            document.querySelectorAll('.context-option').forEach(o => o.classList.remove('selected'));

            // Reset modal states
            clarificationAnswers = { q1: null, q2: null, q3: null };
            analysisState = { step: 'initial', text: '', lowHistory: false };
            selectedParticipant = null;
            messageSide = null;
        }

        // ================== PARTICIPANT DETECTION ==================

        function detectParticipantsFromText(text) {
            // Detect patterns like "[date] Name:" or "Name:"
            const patterns = [
                /\[[\d\/\-\s:,]+\]\s*([^:]+):/g,  // [01/01/2024, 10:30] Name:
                /^([A-Za-z√Ä-√ø\s]+):\s/gm           // Name: at start of line
            ];

            const names = new Set();
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const name = match[1].trim();
                    if (name && name.length > 1 && name.length < 30 && !/^\d+$/.test(name)) {
                        names.add(name);
                    }
                }
            });

            return Array.from(names).slice(0, 5); // Max 5 names
        }

        function showParticipantModal(names) {
            const t = i18n[currentLang];
            const container = document.getElementById('participantOptions');

            container.innerHTML = names.map(name => `
                <label class="participant-option" onclick="selectParticipant(this, '${name.replace(/'/g, "\\'")}')">
                    <input type="radio" name="participant" value="${name}">
                    <span>${name}</span>
                </label>
            `).join('') + `
                <label class="participant-option" onclick="selectParticipant(this, '_other')">
                    <input type="radio" name="participant" value="_other">
                    <span>${t.participantOther}</span>
                </label>
            `;

            document.getElementById('participantModal').classList.add('active');
        }

        function selectParticipant(el, name) {
            document.querySelectorAll('.participant-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedParticipant = name;
        }

        function confirmParticipant() {
            if (!selectedParticipant) return;
            document.getElementById('participantModal').classList.remove('active');
            continueAnalysis();
        }

        // ================== SIDE QUESTION (PRINTS) ==================
        function showSideModal() {
            document.getElementById('sideModal').classList.add('active');
        }

        function confirmSide() {
            const selected = document.querySelector('input[name="messageSide"]:checked');
            if (!selected) return;
            messageSide = selected.value;
            document.getElementById('sideModal').classList.remove('active');
            continueAnalysis();
        }

        // ================== LOW HISTORY MODE ==================
        function countMessages(text) {
            // Count lines that look like messages
            const lines = text.split('\n').filter(l => l.trim().length > 10);
            return lines.length;
        }

        function showLowHistoryModal() {
            const t = i18n[currentLang];
            const container = document.getElementById('clarificationQuestions');

            container.innerHTML = `
                <div class="clarification-item">
                    <p class="clarification-q">${t.clarQ1}</p>
                    <div class="clarification-opts">
                        <span class="clarification-opt" onclick="setClarification('q1', true, this)">${t.clarYes}</span>
                        <span class="clarification-opt" onclick="setClarification('q1', false, this)">${t.clarNo}</span>
                    </div>
                </div>
                <div class="clarification-item">
                    <p class="clarification-q">${t.clarQ2}</p>
                    <div class="clarification-opts">
                        <span class="clarification-opt" onclick="setClarification('q2', true, this)">${t.clarYes}</span>
                        <span class="clarification-opt" onclick="setClarification('q2', false, this)">${t.clarNo}</span>
                    </div>
                </div>
                <div class="clarification-item">
                    <p class="clarification-q">${t.clarQ3}</p>
                    <div class="clarification-opts">
                        <span class="clarification-opt" onclick="setClarification('q3', true, this)">${t.clarYes}</span>
                        <span class="clarification-opt" onclick="setClarification('q3', false, this)">${t.clarNo}</span>
                    </div>
                </div>
            `;

            document.getElementById('lowHistoryModal').classList.add('active');
        }

        function setClarification(q, value, el) {
            clarificationAnswers[q] = value;
            const siblings = el.parentElement.querySelectorAll('.clarification-opt');
            siblings.forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
        }

        function submitClarifications() {
            console.log('submitClarifications called', clarificationAnswers);

            // Check if all answered
            if (clarificationAnswers.q1 === null || clarificationAnswers.q2 === null || clarificationAnswers.q3 === null) {
                console.log('Not all questions answered, returning');
                return;
            }

            const modal = document.getElementById('lowHistoryModal');
            if (modal) modal.classList.remove('active');

            // Apply bonuses based on clarification answers
            if (clarificationAnswers.q1) contextValues.initiative = 'eu'; // User initiates
            if (clarificationAnswers.q2) contextValues.frequency = 'raramente'; // Canceled plans = low meeting
            if (clarificationAnswers.q3) contextValues.emotional = 'cansada'; // Feels more invested

            console.log('Calling continueAnalysis from submitClarifications');
            continueAnalysis();
        }

        // ================== ANALYSIS FLOW ==================

        function startAnalysisFlow() {
            const text = document.getElementById('conversation').value.trim();
            const errorEl = document.getElementById('error');
            const t = i18n[currentLang];

            // Basic validation
            if (!contextValues.objective) {
                errorEl.textContent = t.errorNoDoubt;
                errorEl.classList.add('active');
                return;
            }

            if (inputMode === 'text' && !text) {
                errorEl.textContent = t.errorEmpty;
                errorEl.classList.add('active');
                return;
            }
            if (inputMode === 'text' && text.length < 50) {
                errorEl.textContent = t.errorShort;
                errorEl.classList.add('active');
                return;
            }
            if (inputMode === 'image' && uploadedImages.length === 0) {
                errorEl.textContent = t.errorEmpty;
                errorEl.classList.add('active');
                return;
            }
            errorEl.classList.remove('active');

            analysisState.text = text;
            analysisState.step = 'initial';

            if (inputMode === 'text') {
                // Step 1: Check for participant names
                detectedParticipants = detectParticipantsFromText(text);
                if (detectedParticipants.length >= 2) {
                    analysisState.step = 'participant';
                    showParticipantModal(detectedParticipants);
                    return;
                }

                // Step 2: Check for low history
                const msgCount = countMessages(text);
                if (msgCount < 12) {
                    analysisState.step = 'lowHistory';
                    analysisState.lowHistory = true;
                    showLowHistoryModal();
                    return;
                }
            } else {
                // Image mode: show side question
                analysisState.step = 'side';
                showSideModal();
                return;
            }

            // No modals needed, continue directly
            continueAnalysis();
        }

        function continueAnalysis() {
            console.log('continueAnalysis called', { step: analysisState.step, inputMode, lowHistory: analysisState.lowHistory });

            // If we came from participant modal and still need low history check
            if (analysisState.step === 'participant' && inputMode === 'text') {
                const msgCount = countMessages(analysisState.text);
                if (msgCount < 12 && !analysisState.lowHistory) {
                    analysisState.step = 'lowHistory';
                    analysisState.lowHistory = true;
                    showLowHistoryModal();
                    return;
                }
            }

            // Run the actual analysis
            console.log('Calling runAnalysis');
            runAnalysis();
        }

        function runAnalysis() {
            console.log('runAnalysis called');
            // Show loading state with progress animation
            showLoading();
        }

        function showLoading() {
            console.log('showLoading called');
            const t = i18n[currentLang];
            const overlay = document.getElementById('loadingOverlay');
            const progress = document.getElementById('loadingProgress');
            const stepEl = document.getElementById('loadingStep');

            if (!overlay || !progress || !stepEl) {
                console.error('Loading elements not found:', { overlay, progress, stepEl });
                // Fallback: run analysis directly without loading animation
                analyzeConversationCore();
                return;
            }

            overlay.classList.add('active');
            progress.style.width = '0%';
            console.log('Loading overlay activated');

            // Step 1: Identifying patterns (0-40%)
            stepEl.textContent = t.loadingStep || 'Identificando padr√µes';
            animateProgress(0, 40, 600, () => {
                // Step 2: Calculating scores (40-70%)
                stepEl.textContent = t.loadingStep2 || 'Calculando scores';
                animateProgress(40, 70, 500, () => {
                    // Step 3: Generating diagnosis (70-100%)
                    stepEl.textContent = t.loadingStep3 || 'Gerando diagn√≥stico';
                    animateProgress(70, 100, 400, () => {
                        // Complete - run actual analysis
                        setTimeout(() => {
                            overlay.classList.remove('active');
                            analyzeConversationCore();
                        }, 200);
                    });
                });
            });
        }

        function animateProgress(start, end, duration, callback) {
            const progress = document.getElementById('loadingProgress');
            const step = (end - start) / (duration / 16);
            let current = start;

            const animate = () => {
                current += step;
                if (current >= end) {
                    progress.style.width = end + '%';
                    if (callback) callback();
                } else {
                    progress.style.width = current + '%';
                    requestAnimationFrame(animate);
                }
            };
            animate();
        }

        // Inicializa√ß√£o segura ap√≥s DOM completo
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('alpha-lang') || (navigator.language.startsWith('pt') ? 'pt' : 'en');
            setLang(savedLang);
        });
    </script>

    <div class="legal-section">
        <p class="legal-disclaimer" data-i18n="legalDisclaimer">
            Este relat√≥rio √© uma an√°lise estat√≠stica de padr√µes de comunica√ß√£o e n√£o constitui aconselhamento psicol√≥gico ou m√©dico.
        </p>
        <p class="legal-responsibility" data-i18n="legalResponsibility">
            As decis√µes tomadas a partir deste relat√≥rio s√£o de responsabilidade exclusiva da usu√°ria.
        </p>
        <p class="legal-privacy" data-i18n="legalPrivacy">
            Seus dados s√£o processados localmente e n√£o s√£o armazenados em nossos servidores.
        </p>
        <p class="legal-contact">
            Contato: <a href="mailto:hello@lolalabstudio.com">hello@lolalabstudio.com</a> ¬∑ Controladora: Lola Lab
        </p>
    </div>

    <footer>
        Made by <a href="https://lolalab.studio" target="_blank">Lola Lab</a>
    </footer>
</body>
</html>
